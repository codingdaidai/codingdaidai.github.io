<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"codingdaidai.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="codingdaidai">
<meta property="og:url" content="https://codingdaidai.github.io/page/4/index.html">
<meta property="og:site_name" content="codingdaidai">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Lingyun Zhou">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://codingdaidai.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>codingdaidai</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">codingdaidai</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录 分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/04/27/%E5%89%91%E6%8C%87offer/%E9%93%BE%E8%A1%A8/%E4%B8%A4%E4%B8%AA%E9%93%BE%E8%A1%A8%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%85%AC%E5%85%B1%E7%BB%93%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/27/%E5%89%91%E6%8C%87offer/%E9%93%BE%E8%A1%A8/%E4%B8%A4%E4%B8%AA%E9%93%BE%E8%A1%A8%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%85%AC%E5%85%B1%E7%BB%93%E7%82%B9/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-27 18:50:33" itemprop="dateCreated datePublished" datetime="2021-04-27T18:50:33+08:00">2021-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-25 18:22:39" itemprop="dateModified" datetime="2021-04-25T18:22:39+08:00">2021-04-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>JZ36</p>
<p>输入两个链表，找出它们的第一个公共结点。（注意因为传入数据是链表，所以错误测试数据的提示是用其他方式显示的，保证传入数据是正确的）</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul>
<li>拼接链表一次遍历：两个链表长度分别为L1+C、L2+C， C为公共部分的长度，按照楼主的做法： 第一个人走了L1+C步后，回到第二个人起点走L2步；第2个人走了L2+C步后，回到第一个人起点走L1步。 当两个人走的步数都为L1+L2+C时就相遇了</li>
<li>栈：从公共结点往后，两个链表的所有元素都相同，把两个链表分别进栈再出栈开始比较，一直到他们不相同的地方</li>
<li>双指针：先获取两个链表的长度，让长链表的指针先走一个长度差的距离，两个指针再开始同时往后</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">FindFirstCommonNode</span><span class="params">(ListNode pHead1, ListNode pHead2)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ListNode p1 = pHead1;</span><br><span class="line">        ListNode p2 = pHead2;</span><br><span class="line">        <span class="keyword">while</span>(p1 != p2)&#123;</span><br><span class="line">            p1 = p1!=<span class="keyword">null</span>?p1.next:pHead2;</span><br><span class="line">            p2 = p2!=<span class="keyword">null</span>?p2.next:pHead1;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> p1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>时间：o(m+n) 最坏在最后一个元素才相遇</p>
<p>空间：o(1)</p>
<p>？：三目运算符写成if-else超时了</p>
<p>双指针;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">FindFirstCommonNode</span><span class="params">(ListNode pHead1, ListNode pHead2)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        ListNode p1 = pHead1;</span><br><span class="line">        ListNode p2 = pHead2;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> len1 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> len2 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(p1 != <span class="keyword">null</span>)&#123;</span><br><span class="line">            p1 = p1.next;</span><br><span class="line">            len1++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(p2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">            p2 = p2.next;</span><br><span class="line">            len2++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        p1 = pHead1;</span><br><span class="line">        p2 = pHead2;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(len1 &lt; len2)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;len2-len1;i++)&#123;</span><br><span class="line">                p2 = p2.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;len1-len2;i++)&#123;</span><br><span class="line">                p1 = p1.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(p1 != p2)&#123;</span><br><span class="line">            p1 = p1.next;</span><br><span class="line">            p2 = p2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>时间：o(m+n) 实际要遍历两次，一次获取长度，一次找公共结点</p>
<p>空间：o(1)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/04/27/%E5%89%91%E6%8C%87offer/%E6%95%B0%E7%BB%84/%E6%9E%84%E5%BB%BA%E4%B9%98%E7%A7%AF%E6%95%B0%E7%BB%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/27/%E5%89%91%E6%8C%87offer/%E6%95%B0%E7%BB%84/%E6%9E%84%E5%BB%BA%E4%B9%98%E7%A7%AF%E6%95%B0%E7%BB%84/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-04-27 18:50:33 / Modified: 14:54:03" itemprop="dateCreated datePublished" datetime="2021-04-27T18:50:33+08:00">2021-04-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>JZ51</p>
<p>构建乘积数组</p>
<p>给定一个数组A[0,1,…,n-1],请构建一个数组B[0,1,…,n-1],其中B中的元素B[i]=A[0]<em>A[1]</em>…*A[i-1]<em>A[i+1]</em>…*A[n-1]。不能使用除法。（注意：规定B[0] = A[1] * A[2] * … * A[n-1]，B[n-1] = A[0] * A[1] * … * A[n-2];）</p>
<p>对于A长度为1的情况，B无意义，故而无法构建，因此该情况不会存在。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul>
<li>依次置1赋值：B的当前元素相当于A中的对应元素置1后的所有元素的乘积，用一个临时变量存储A的对应元素，在生成了B中元素之后再还原A数组<ul>
<li>时间复杂度有点高，n很大时太费时</li>
</ul>
</li>
<li>上下三角矩阵（减低时间复杂度）：先计算下三角的乘积，再计算上三角的乘积并且拼接<ul>
<li>实际也是对应元素置1</li>
<li>先计算下三角：我们先计算每个新元素的前驱元素的乘积，可以观察到，在遍历B的时候，每次乘积B[i]实际上只比B中的前一个元素B[i-1]多了一个因子即A[i-1],运用这个关系可以避免方法1 中的循环套循环</li>
<li>再计算上三角：同理，最终得到的即为B的最终值</li>
</ul>
</li>
</ul>
<p>![7485844_1568205854244_68AFE3F9495897962EE4D9BE76059D3F](D:\Files\Daily Task\images\7485844_1568205854244_68AFE3F9495897962EE4D9BE76059D3F.png)</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>依次置1赋值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] multiply(<span class="keyword">int</span>[] A) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> len = A.length;</span><br><span class="line">        <span class="keyword">int</span>[] B = <span class="keyword">new</span> <span class="keyword">int</span>[len];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> tmp = A[i];</span><br><span class="line">            A[i] = <span class="number">1</span>;</span><br><span class="line">            B[i] = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j&lt;len;j++)&#123;</span><br><span class="line">                B[i] = B[i]*A[j];</span><br><span class="line">            &#125;</span><br><span class="line">            A[i] = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> B;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>时间：O(n^2)   对B 中每个新元素，都遍历一次原数组</p>
<p>空间：O(1)</p>
<p>上下三角：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] multiply(<span class="keyword">int</span>[] A) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> len = A.length;</span><br><span class="line">        <span class="keyword">int</span>[] B = <span class="keyword">new</span> <span class="keyword">int</span>[len];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//下三角</span></span><br><span class="line">        B[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i&lt;len;i++)&#123;</span><br><span class="line">            B[i] = B[i-<span class="number">1</span>]*A[i-<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//上三角从下往上计算</span></span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="number">1</span>; <span class="comment">//用一个临时b</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = len-<span class="number">1</span>;i &gt;= <span class="number">0</span>;i--)&#123;</span><br><span class="line">            B[i] = B[i]*tmp;</span><br><span class="line">            tmp = tmp*A[i];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> B;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/04/27/%E5%89%91%E6%8C%87offer/%E6%A8%A1%E6%9D%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/27/%E5%89%91%E6%8C%87offer/%E6%A8%A1%E6%9D%BF/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-27 18:50:33" itemprop="dateCreated datePublished" datetime="2021-04-27T18:50:33+08:00">2021-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-23 21:59:16" itemprop="dateModified" datetime="2021-04-23T21:59:16+08:00">2021-04-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul>
<li></li>
<li></li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>时间：</p>
<p>空间：</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/04/25/%E9%A1%B9%E7%9B%AE/4%20%E5%B9%BF%E5%91%8A%E6%8A%95%E6%94%BE%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/%E9%A1%B9%E7%9B%AE/4%20%E5%B9%BF%E5%91%8A%E6%8A%95%E6%94%BE%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-25 12:39:01" itemprop="dateCreated datePublished" datetime="2021-04-25T12:39:01+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-24 23:20:36" itemprop="dateModified" datetime="2021-04-24T23:20:36+08:00">2021-04-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="广告投放系统开发"><a href="#广告投放系统开发" class="headerlink" title="广告投放系统开发"></a>广告投放系统开发</h1><h2 id="Spring-IOC和MVC基础"><a href="#Spring-IOC和MVC基础" class="headerlink" title="Spring IOC和MVC基础"></a>Spring IOC和MVC基础</h2><h3 id="Spring-IOC原理"><a href="#Spring-IOC原理" class="headerlink" title="Spring IOC原理"></a>Spring IOC原理</h3><p>![1618561118(1)](D:\Files\Daily Task\images\1618561118(1).png)</p>
<p>spring启动时会读取bean配置信息，并在spring容器中生成一份相应的bean配置注册表，然后根据注册表实例化各个bean，装配好bean之间的依赖关系，为上层应用提供准备就绪的运行环境</p>
<ol>
<li>读取bean配置信息：在项目中定义好的bean例如图中3种，告诉spring应用里需要的JavaBean以及各个bean之间的依赖关系</li>
<li>根据bean注册表实例化bean：在业务中实现，在应用程序中把各个bean编写出来，并用如图三种注解或其他注解标识出来，说明写出的Java类是一个让spring去管理的JavaBean</li>
<li>将bean实例放到spring容器中：启动容器，读取配置文件，初始化各个bean，并完成bean之间的依赖注入</li>
<li>应用程序使用：前面完成了bean实例的创建和管理并把它放到了spring容器中（实现了各个服务，接口，这些bean由spring管理），就可以提供给应用程序使用。容器中有一份bean的定义注册表，可以通过定义的配置.class这样的标识从注册表中拿取bean（例如Java类的配置，根据名字定义的bean  .calss），spring自己会维护一份bean的缓存，内部用hashmap实现，可以快速找到对应的bean交给应用程序完成功能</li>
</ol>
<h3 id="Spring-MVC模块解析"><a href="#Spring-MVC模块解析" class="headerlink" title="Spring MVC模块解析"></a>Spring MVC模块解析</h3><p>mvc通过预定义的组件用来简化web开发和网络接口，下图中间灰色模块都是Spring MVC提供的组件</p>
<p>![1618566852(1)](D:\Files\Daily Task\images\1618566852(1).png)</p>
<p><strong>过程</strong>：Http请求：从client到DispatchServlet，它是spring提供的前端控制器，所有的请求由他统一分发；在分发给controller之前，需要通过HandlerMapping定位到具体的controller；然后DispatchServlet将请求提交给对应的controller，controller要处理用户的请求，需要实现controller接口，需要保证他是线程安全且可重用的；controller会调用我们写的业务处理逻辑service；service会返回ModelAndView给前端控制器，Model是应用程序需要的数据View是视图信息；DispatchServle在得到处理结果后，会去查询一个或多个处理视图的映射ViewResolver,找到ModelAndView指定的视图；再对Model数据渲染，得到一个view；最后Http响应返回客户端</p>
<p>DispatchServlet：</p>
<ol>
<li>捕获特定格式的url请求</li>
<li>初始化DispatchServlet上下文，执行各个逻辑</li>
<li>初始化springmvc各个组件，装配到DispatchServlet中</li>
</ol>
<h2 id="Spring-Boot常用功能介绍"><a href="#Spring-Boot常用功能介绍" class="headerlink" title="Spring Boot常用功能介绍"></a>Spring Boot常用功能介绍</h2><p>spring boot的启动原理</p>
<p>@springbootconfiguration</p>
<p>@enableautoconfiguration自动配置</p>
<p>@componentscan</p>
<ol>
<li>spring boot应用启动入口</li>
<li>容器启动之后执行的操作</li>
<li>profile环境配置</li>
<li>配置信息封装成实体类</li>
<li>定时任务</li>
</ol>
<h3 id="SpringBoot-常用特性总结"><a href="#SpringBoot-常用特性总结" class="headerlink" title="SpringBoot 常用特性总结"></a>SpringBoot 常用特性总结</h3><ol>
<li><strong>ConfigurationProperties</strong></li>
</ol>
<p>SpringBoot 的一个很重要的功能是外部化配置，可以直接访问配置文件（application.yml）中定义的字段值，并能够完成属性绑定。</p>
<p>但是，需要注意：@ConfigurationProperties 并没有把当前类注册成为一个 Spring 的 Bean。所以，我们在使用时都会配合 @Component 注解直接进行注入。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;adconf.mysql&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySQLConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> Integer port;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到，ConfigurationProperties 的 prefix 属性指定了 adconf.mysql。所以，它会映射到 application.yml 中对应的字段。例如：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">adconf:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">Djangobbs</span></span><br></pre></td></tr></table></figure>
<p>2.<strong>CommandLineRunner 与 ApplicationRunner</strong></p>
<p>CommandLineRunner 与 ApplicationRunner 接口是在 Spring 容器启动之后做的一些自定义操作。</p>
<ul>
<li>CommandLineRunner</li>
</ul>
<p>接口被用作将其加入 Spring 容器中时执行其 run 方法。多个 CommandLineRunner 可以被同时执行在同一个 Spring 上下文中并且执行顺序是以 Order 注解的参数顺序一致。注意：需要把 CommandLineRunner 加入到 Spring 容器中。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(value = 1)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Runner01</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... strings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Running Runner01&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ApplicationRunner</strong></li>
</ul>
<p>阅读官方的 javadoc，可以发现，与 CommandLineRunner 几乎一样，区别在于接收的参数不一样。CommandLineRunner 的参数是最原始的参数，没有做任何处理。ApplicationRunner 的参数是 ApplicationArguments，是对原始参数做了进一步的封装。使用方法也是一样的，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(value = 2)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Runner02</span> <span class="keyword">implements</span> <span class="title">ApplicationRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ApplicationArguments applicationArguments)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Running Runner02&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>@Scheduled</strong></li>
</ol>
<p>@Scheduled 注解用于计划执行，它提供了多种参数控制执行的时间和频率等。例如：fixedRate 以固定的频率执行、cron 以 crontab 表达式的规则执行等等。</p>
<p>@Scheduled 任务是非常常用的，使用起来也非常简单：1. 加载到 Spring 容器中；2. 指定你想要的执行规则。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Scheduled(fixedRate = 5000)         上一次开始执行时间点之后5秒再执行</span></span><br><span class="line">    <span class="comment">// @Scheduled(fixedDelay = 5000)        上一次执行完毕时间点之后5秒再执行</span></span><br><span class="line">    <span class="comment">// @Scheduled(cron = &quot;*/5 * * * * *&quot;)   通过 crontab 表达式定义规则</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 1000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">helloSpringBoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello SpringBoot&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="广告投放系统数据表设计"><a href="#广告投放系统数据表设计" class="headerlink" title="广告投放系统数据表设计"></a>广告投放系统数据表设计</h2><h3 id="四个概念"><a href="#四个概念" class="headerlink" title="四个概念"></a>四个概念</h3><ol>
<li>用户账户：广告主的账户，需要在平台上完成账户的注册，然后才能完成广告的投放</li>
<li>推广计划：一类品牌或产品广告投放的规划，自身并不定义太多关于广告自身的信息，它会将信息打包下放到推广单元层级</li>
<li>推广单元：一个确定的广告投放策略，描述了投放广告的规则信息。一个推广计划下有多个维度的推广单元（一对多），推广单元一般会做一些限制动作，例如<ol>
<li>关键词限制：只有广告请求带有某些关键词才会认为请求想要这个推广单元</li>
<li>地域限制</li>
<li>兴趣限制</li>
</ol>
</li>
<li>创意（广告物料）：命中推广单元后，需要给广告请求返回数据，例如文本图片视频，这些成为创意；推广单元与创意是多对多关系</li>
</ol>
<p>![1618572696(1)](D:\Files\Daily Task\images\1618572696(1).png)</p>
<h3 id="设计数据表"><a href="#设计数据表" class="headerlink" title="设计数据表"></a>设计数据表</h3><p>根据各个层级设计表结构</p>
<p>注意：没有实现用户的权限校验，可以后续扩展（开源框架）</p>
<p>![1618572939(1)](D:\Files\Daily Task\images\1618572939(1).png)</p>
<p>![1618573207(1)](D:\Files\Daily Task\images\1618573207(1).png)</p>
<p>![1618573305(1)](D:\Files\Daily Task\images\1618573305(1).png)</p>
<p>投放系统是比较简单的模块，其核心实现的功能就是对广告数据（各个表）进行增删改查，即能够让用户（广告主/代理商）对数据进行查看、上传、修改与删除</p>
<h2 id="创建广告投放系统子模块"><a href="#创建广告投放系统子模块" class="headerlink" title="创建广告投放系统子模块"></a>创建广告投放系统子模块</h2><p>在imooc-ad-service下创建<strong>ad-sponsor模块（投放系统）</strong>，写好pom文件，添加依赖和编译插件</p>
<p>在resours下创建application.yml编写配置文件：jpa？hebernate？datasource？eureka的配置</p>
<h2 id="Model层设计-数据表实体类定义"><a href="#Model层设计-数据表实体类定义" class="headerlink" title="Model层设计 数据表实体类定义"></a>Model层设计 数据表实体类定义</h2><h3 id="启动程序"><a href="#启动程序" class="headerlink" title="启动程序"></a>启动程序</h3><p>首先创建springboot的启动程序，SponsorApplication</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableFeignClients</span> <span class="comment">//这个微服务中可以调用其他微服务，这里是为了将来在dashboard中实现监控</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span> <span class="comment">//断路器，也是为了实现监控</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span> <span class="comment">//标识它是一个EurekaClient，能从注册中心拿到其他微服务的信息</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span> <span class="comment">//指明是springboot程序</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SponsorApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SponsorApplication.class,args); <span class="comment">//启动程序</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="AdUser表实体类定义"><a href="#AdUser表实体类定义" class="headerlink" title="AdUser表实体类定义"></a>AdUser表实体类定义</h3><p>用户账户表的定义：创建第一个实体对象ad-user,实体对象是跟数据表相对应的，一般称为entity；创建包entity存放数据表实体对象的定义，创建AdUser类，编写第一张表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.constant.CommonStatus;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span>  <span class="comment">//Lombok注解，实现get和set的无参和全参的构造函数</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span> <span class="comment">//标注为实体类</span></span><br><span class="line"><span class="meta">@Table(name = &quot;ad_user&quot;)</span> <span class="comment">//指定实体类对应到数据库的哪一张表</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="comment">//主键注解</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span> <span class="comment">//标注怎么生成，这里主键使用自增策略，相应地在存储时不需要使用id这个字段</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;,nullable = false)</span> <span class="comment">//定义对应数据库表的字段名，不允许为null，一般开发中字段都不允许为空</span></span><br><span class="line">    <span class="keyword">private</span> Long id; <span class="comment">//第一个属性，是数据库中的主键key，用@Id标注它</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span> <span class="comment">//标注它是数据库表的基本属性，可以不写，默认是basic。与之对应的有@Transient注解，不把属性当作表的字段</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;username&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;token&quot;,nullable = false)</span> <span class="comment">//token 接口，便于自己扩展用户接入系统</span></span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;user_status&quot;,nullable = false)</span> <span class="comment">//默认用户创建时是一个有效状态，不需要指定</span></span><br><span class="line">    <span class="keyword">private</span> Integer userStatus;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;create_time&quot;,nullable = false)</span> <span class="comment">//以下两个time即当前时间，也不需要自己指定</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;update_time&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    写一个构造函数用于用户的创建，由上面的字段设置，只需指定username和token这两个字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdUser</span><span class="params">(String username,String token)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.token = token;</span><br><span class="line">        <span class="keyword">this</span>.userStatus = CommonStatus.VALID.getStatus();</span><br><span class="line">        <span class="keyword">this</span>.createTime = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">this</span>.updateTime = <span class="keyword">this</span>.createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>对于用户状态这个属性userStatus，分为两个，有效和无效，由于在将来编写推广计划和推广单元时也存在这样的状态属性，这里考虑把状态写成一个常量，其他的表也可以共用。于是在com.imooc.ad下创建一个常量包constant，创建CommonStatus即通用状态，使用枚举类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span> <span class="comment">//可以主动获取这个枚举中的属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">CommonStatus</span> </span>&#123;</span><br><span class="line">    VALID(<span class="number">1</span>,<span class="string">&quot;有效状态&quot;</span>), <span class="comment">//定义两个状态属性</span></span><br><span class="line">    INVALID(<span class="number">0</span>,<span class="string">&quot;无效状态&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer status; <span class="comment">//属性定义包含Integer类型的status和string类型的描述信息</span></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    CommonStatus(Integer status,String desc)&#123;<span class="comment">//写构造函数</span></span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>于是在AdUser的构造函数中可以使用这个枚举，即</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.userStatus = CommonStatus.VALID.getStatus();</span><br></pre></td></tr></table></figure>


<h3 id="AdPlan和AdUnit表实体类定义"><a href="#AdPlan和AdUnit表实体类定义" class="headerlink" title="AdPlan和AdUnit表实体类定义"></a>AdPlan和AdUnit表实体类定义</h3><p>对应的是推广计划和推广单元的表的定义</p>
<p>AdPlan：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.constant.CommonStatus;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;ad_plan&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdPlan</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;user_id&quot;,nullable = false)</span> <span class="comment">//正常字段，开发中定义表一般不使用外键，因为占用空间，且和母表之间有关联，母表损坏子表难恢复</span></span><br><span class="line">    <span class="comment">//且在迁移数据表和分库分表时不好操作和维护，在应用程序中再去使用外键</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;plan_name&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String planName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;plan_status&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Integer planStatus;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;start_name&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date startDate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;end_date&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date endDate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;create_time&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;end_time&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdPlan</span><span class="params">(Long userId,String planName,</span></span></span><br><span class="line"><span class="function"><span class="params">                  Date startDate,Date endDate)</span></span>&#123; <span class="comment">//需要写入的有这四个字段</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">        <span class="keyword">this</span>.planName = planName;</span><br><span class="line">        <span class="keyword">this</span>.planStatus = CommonStatus.VALID.getStatus();</span><br><span class="line">        <span class="keyword">this</span>.startDate = startDate;</span><br><span class="line">        <span class="keyword">this</span>.endDate = endDate;</span><br><span class="line">        <span class="keyword">this</span>.createTime = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">this</span>.endTime = <span class="keyword">this</span>.createTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>AdUnit</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.constant.CommonStatus;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;ad_unit&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;lpan_id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long planId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;unit_name&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String unitName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;unit_status&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Integer unitStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 广告位类型，例如开屏，贴片，中贴...*/</span></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;position_type&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Integer positionType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;budget&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long budget;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;create_time&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;end_time&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdUnit</span><span class="params">(Long planId,String unitName,</span></span></span><br><span class="line"><span class="function"><span class="params">                  Integer positionType,Long budget)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.planId = planId;</span><br><span class="line">        <span class="keyword">this</span>.unitName = unitName;</span><br><span class="line">        <span class="keyword">this</span>.unitStatus = CommonStatus.VALID.getStatus();</span><br><span class="line">        <span class="keyword">this</span>.positionType = positionType;</span><br><span class="line">        <span class="keyword">this</span>.budget = budget;</span><br><span class="line">        <span class="keyword">this</span>.createTime = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">this</span>.endTime = <span class="keyword">this</span>.createTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="AdUnit的维度限制"><a href="#AdUnit的维度限制" class="headerlink" title="AdUnit的维度限制"></a>AdUnit的维度限制</h3><p>对于AdUnit推广单元，设置3个限制维度，这里有关键词，地域，兴趣，下面编写这些字段并把他们映射到推广单元；在entity下创建unit_condition包存放，下面创建不同的限制维度</p>
<p>AdUnitKeyword：关键词限制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.entity.unit_condition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;ad_unit_keyword&quot;)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">关键词限制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitKeyword</span> </span>&#123;<span class="comment">//广告请求带有某关键词时才会与推广单元匹配</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;unit_id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long unitId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;keyword&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String keyword;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdUnitKeyword</span><span class="params">(Long unitId,String keyword)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unitId = unitId;</span><br><span class="line">        <span class="keyword">this</span>.keyword = keyword;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>其他限制类似</p>
<p>AdUnitIt：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.entity.unit_condition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;ad_unit_it&quot;)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">兴趣限制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitIt</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;unit_id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long unitId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;it_tag&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String itTag;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdUnitIt</span><span class="params">(Long unitId,String itTag)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unitId = unitId;</span><br><span class="line">        <span class="keyword">this</span>.itTag = itTag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>AdUnitDistrict：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.entity.unit_condition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;ad_unit_district&quot;)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">地域限制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitDistrict</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;unit_id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long unitId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;province&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String province;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;city&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdUnitDistrict</span><span class="params">(Long unitId,String province,</span></span></span><br><span class="line"><span class="function"><span class="params">                          String city)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unitId = unitId;</span><br><span class="line">        <span class="keyword">this</span>.province = province;</span><br><span class="line">        <span class="keyword">this</span>.city = city;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="Cretive表实体类定义"><a href="#Cretive表实体类定义" class="headerlink" title="Cretive表实体类定义"></a>Cretive表实体类定义</h3><p>即创意表，返回给客户端的数据，这个表的字段比较多</p>
<p>Creative ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.entity.unit_condition;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;ad_creative&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Creative</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;name&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 创意类型 */</span></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;type&quot;,nullable = false)</span>  <span class="comment">//主类型标识这个创意的类型，是图片，文本，视频等等</span></span><br><span class="line">    <span class="keyword">private</span> Integer type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物料类型，比如图片可以是bmp，jpg等*/</span></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;material_type&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Integer materialType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;height&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Integer height;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;width&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Integer width;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物料大小 */</span></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;size&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物料时长，只有视频不为0*/</span></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;duration&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Integer duration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 审核状态:用户上传的物料需要运营去审核，再标记可用否 */</span></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;audit_status&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Integer auditStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物料由用户上传，因此会关联用户id */</span></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;user_id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物料存储的地址，例如云上，最终返回给请求方 */</span></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;url&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;create_time&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;update_time&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>Creative表中两个type字段的说明</strong>：</p>
<p>这里再常量包constant下创建两个枚举类来举例说明：</p>
<p>CreativeType：是创意类型，大概指示创意是图片图片还是视频等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.constant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">CreativeType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    IMAGE(<span class="number">1</span>,<span class="string">&quot;图片&quot;</span>),</span><br><span class="line">    VIDEO(<span class="number">2</span>,<span class="string">&quot;视频&quot;</span>),</span><br><span class="line">    TEXT(<span class="number">3</span>,<span class="string">&quot;文本&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    CreativeType(<span class="keyword">int</span> type,String desc)&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>CreativeMaterialType：物料类型，更具体地指示物料的格式，可以当作是大类型的子类型，这些具体类型要告知请求方方便他们选择对应的解码器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.constant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">CreativeMaterialType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    JPG(<span class="number">1</span>,<span class="string">&quot;jpg&quot;</span>),</span><br><span class="line">    BMP(<span class="number">2</span>,<span class="string">&quot;bmp&quot;</span>),</span><br><span class="line"></span><br><span class="line">    MP4(<span class="number">3</span>,<span class="string">&quot;mp4&quot;</span>),</span><br><span class="line">    AVI(<span class="number">4</span>,<span class="string">&quot;avi&quot;</span>),</span><br><span class="line"></span><br><span class="line">    TXT(<span class="number">5</span>,<span class="string">&quot;txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    CreativeMaterialType(<span class="keyword">int</span> type,String desc)&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Creative表的关联"><a href="#Creative表的关联" class="headerlink" title="Creative表的关联"></a>Creative表的关联</h3><p>由于创意和推广单元是多对多的关系，创建一个新的表来存放，这个表里应该有创意的id和推广单元的id字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.entity.unit_condition;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;creative_unit&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreativeUnit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;creative_id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long creativeId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Basic</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;unit_id&quot;,nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long unitId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreativeUnit</span><span class="params">(Long creativeId,Long unitId)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.creativeId = creativeId;</span><br><span class="line">        <span class="keyword">this</span>.unitId = unitId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Dao层设计-数据表Dao接口定义"><a href="#Dao层设计-数据表Dao接口定义" class="headerlink" title="Dao层设计 数据表Dao接口定义"></a>Dao层设计 数据表Dao接口定义</h2><p>model层完成了各个数据表实体类的定义，现在需要一些接口或者实现类来查询这些数据，这里使用spring data JPA，只需要定义一个接口，并实现相应的继承自JPA repository，就自动拥有一些查询表的方法，也可自定义，最终实现对数据表的增删改查。</p>
<h3 id="各个数据表的接口定义"><a href="#各个数据表的接口定义" class="headerlink" title="各个数据表的接口定义"></a>各个数据表的接口定义</h3><p>在com.imooc.ad下创建dao包来存放各个数据表的查询接口</p>
<p>AdUserRepository接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdUser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AdUserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">AdUser</span>,<span class="title">Long</span>&gt; </span>&#123;<span class="comment">//JpaRepository接收两个泛型，一个是要查询的实体类的class</span></span><br><span class="line">    <span class="comment">// 定义，第二个是它的主键类型。JpaRepository中实现了多种操作数据表的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义其他的查询方法：例如根据用户名查找用户记录,因为用户名在创建时是唯一的，所以查找结果应该是单个的实体,有返回AdUser实体类，没有返回null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *&lt;h2&gt;根据用户名查找用户记录&lt;/h2&gt;</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function">AdUser <span class="title">findByUsername</span><span class="params">(String username)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>AdPlanRepository：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdPlan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AdPlanRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">AdPlan</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *查找AdPlan：id即可唯一标识，增加一个UserId更加确定，避免不同UserId查询别人的数据（横向越权）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">AdPlan <span class="title">findByIdAndUserId</span><span class="params">(Long id,Long userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用列表的方式查询多个AdPlan.根据给出的id列表以及userid查出AdPlan列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;AdPlan&gt; <span class="title">findAllByIdInAndUserId</span><span class="params">(List&lt;Long&gt; ids,Long userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdPlan <span class="title">findByUserIdAndPlanName</span><span class="params">(Long userId,String planName)</span></span>;<span class="comment">//通过userid和planname查询，单个用户的plan是唯一的</span></span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;AdPlan&gt; <span class="title">findAllByPlanStatus</span><span class="params">(Integer status)</span></span>; <span class="comment">//通过plan的状态查询</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>AdUnitRepository:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdUnit;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AdUnitRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">AdUnit</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnit <span class="title">findByPlanIdAndUnitName</span><span class="params">(Long planId,String unitName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;AdUnit&gt; <span class="title">findAllByUnitStatus</span><span class="params">(Integer unitStatus)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>CreativeRepository:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.unit_condition.Creative;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CreativeRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Creative</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//不写方法，基本的根据主键查询，save，update,delete等可以直接使用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="JPA"><a href="#JPA" class="headerlink" title="JPA"></a>JPA</h3><ol>
<li>优点：定义和使用方便</li>
<li>缺点：查询效率相对mybatis或直接基于sql语句低一些</li>
</ol>
<p>对于本投放系统，不需要很高的性能。后期可用mybatis</p>
<blockquote>
<p><em><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_28289405/article/details/82382441">Spring Data JPA</a></em></p>
</blockquote>
<h3 id="unit-condition包下的接口定义"><a href="#unit-condition包下的接口定义" class="headerlink" title="unit_condition包下的接口定义"></a>unit_condition包下的接口定义</h3><p>![1618662627(1)](D:\Files\Daily Task\images\1618662627(1).png)</p>
<p>对应的创建接口，其中暂时不写自定义的查询方法</p>
<h2 id="Service层-用户服务功能实现"><a href="#Service层-用户服务功能实现" class="headerlink" title="Service层 用户服务功能实现"></a>Service层 用户服务功能实现</h2><p>service层：即为广告主提供数据的增删改查的服务，在com.imooc.ad下创建service包</p>
<h3 id="IUserService接口"><a href="#IUserService接口" class="headerlink" title="IUserService接口"></a>IUserService接口</h3><p>先创建一个接口定义IUserService,对User实现增删改查的服务，这里只提供一个createUser创建用户方法，可扩展，例如user的update，delete等操作；</p>
<p>在创建IUserService之前，定义两个对象：一个是创建这个user需要给投放系统的数据；一个是创建完后需要返回给广告主的数据。数据定义放在vo包下。（把请求和相应两个数据包装成Java对象）这样方便统一管理</p>
<p>vo是啥？<a target="_blank" rel="noopener" href="https://www.cnblogs.com/qixuejia/p/4390086.html">领域驱动设计系列文章（2）——浅析VO、DTO、DO、PO的概念、区别和用处</a></p>
<p>CreateUserRequest：数据请求对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">jpackage com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 要创建用户，需要CreateUserRequest这个请求对象。创建时只需要用户提供他的username，token由我们的后台生成</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateUserRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    写一个validate验证方法看是否有效,如果不为空，返回true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validate</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> !StringUtils.isEmpty(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>CreateUserResponse：返回数据对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建用户之后返回给广告主的响应：包含哪些数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateUserResponse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在定义IUserService时可以使用这两个vo对象的定义</p>
<p>IUserService接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreateUserRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreateUserResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *&lt;h2&gt;创建用户&lt;/h2&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">CreateUserResponse <span class="title">createUser</span><span class="params">(CreateUserRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;<span class="comment">//创建过程可能抛出异常，使用之前在common模块中创建的异常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还可以扩展例如updateuser，deleteuser等方法，同样这样定义vo对象</p>
<h3 id="UserService接口实现"><a href="#UserService接口实现" class="headerlink" title="UserService接口实现"></a>UserService接口实现</h3><p>为了实现这个userservice这个接口，给出实现类，在service包下创建Impl包存储实现</p>
<p>在其下创建UserServiceImpl类，让他实现IUserService这个接口</p>
<p>UserServiceImpl接口实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.service.Impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.AdUserRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdUser;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.utils.CommonUtils;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreateUserRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreateUserResponse;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.transaction.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span> <span class="comment">//添加日志属性</span></span><br><span class="line"><span class="meta">@Service</span> <span class="comment">//标记为一个springBean</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建用户响应使用Dao接口，需要注入,根据提示把它写成一个构造函数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdUserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(AdUserRepository userRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>  <span class="comment">//实现createUser方法</span></span><br><span class="line">    <span class="meta">@Transactional</span> <span class="comment">//往数据库写入，需要开启事务的注解</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CreateUserResponse <span class="title">createUser</span><span class="params">(CreateUserRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!request.validate())&#123; <span class="comment">//验证请求是否有效，抛出的异常统一管理，在Constants里定义错误信息</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//查是否存在同名的用户信息</span></span><br><span class="line">        AdUser oldUser = userRepository.findByUsername(request.getUsername());</span><br><span class="line">        <span class="keyword">if</span> (oldUser!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.SAME_NAME_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//创建新用户</span></span><br><span class="line">        AdUser newUser = userRepository.save(<span class="keyword">new</span> AdUser(</span><br><span class="line">                request.getUsername(), CommonUtils.md5(request.getUsername())</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreateUserResponse(</span><br><span class="line">                newUser.getId(),newUser.getUsername(),newUser.getToken(),</span><br><span class="line">                newUser.getCreateTime(),newUser.getUpdateTime()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>错误信息放在Constants包下的Constants里统一管理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.constant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Constants</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorMsg</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REQUEST_PARAM_ERROR = <span class="string">&quot;请求参数错误&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAME_NAME_ERROR = <span class="string">&quot;存在同名的用户&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>注意这里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建新用户</span></span><br><span class="line">     AdUser newUser = userRepository.save(<span class="keyword">new</span> AdUser(</span><br><span class="line">             request.getUsername(), CommonUtils.md5(request.getUsername())</span><br><span class="line">     ));</span><br></pre></td></tr></table></figure>
<p>使用jpa的save函数，AdUser里写了构造函数需要传递username和token两个参数，这里token由对username md5实现（接入用户系统后，也可用其他方法实现token）；</p>
<p>于是在com.imooc.ad下创建一个工具utils包，下面创建一个工具类CommonUtils，写一个获取字符串的md5的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">md5</span><span class="params">(String value)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> DigestUtils.md5Hex(value).toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此完成了关于用户账户的代码编写</p>
<h3 id="IAdService接口"><a href="#IAdService接口" class="headerlink" title="IAdService接口"></a>IAdService接口</h3><p>这部分是ad-plan推广计划服务功能的实现，与user-service类似</p>
<p>在service下创建接口，在vo中定义vo对象，在Impl包下写实现</p>
<p>AdPlanRequest：创建，更新和删除AdPlan</p>
<p>？：为什么定义成string类型的startTime，啥叫序列化反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdPlanRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String planName;</span><br><span class="line">    <span class="keyword">private</span> String startTime;  <span class="comment">//string类型。需反序列化将它转化为java.util.date类型</span></span><br><span class="line">    <span class="keyword">private</span> String endDate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建的时候做一个校验的函数:这几个字段都不为空</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">createValidate</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userId != <span class="keyword">null</span> &amp;&amp; !StringUtils.isEmpty(planName)</span><br><span class="line">                &amp;&amp; !StringUtils.isEmpty(startTime)</span><br><span class="line">                &amp;&amp; !StringUtils.isEmpty(endDate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新参数时的校验:更新根据id和userid去查找plan，只需要校验这两个参数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateValidate</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> id != <span class="keyword">null</span> &amp;&amp; userId != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除时的检验</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteValidate</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> id != <span class="keyword">null</span> &amp;&amp; userId !=<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>AdPlanResponse：adplan响应</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdPlanResponse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id; <span class="comment">//只返回id和planname代表已经创建成功</span></span><br><span class="line">    <span class="keyword">private</span> String plan;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>AdPlanGetRequest：查询对象，根据userId返回AdPlan</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdPlanGetRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId; <span class="comment">//根据用户id去get计划planname，一个可能有多个，所以支持批量获取</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; ids;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validate</span><span class="params">()</span></span>&#123; <span class="comment">//判断条件：userId不为null且ids的元素不为空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userId != <span class="keyword">null</span> &amp;&amp; !CollectionUtils.isEmpty(ids);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>创建好三个功能对应的vo对象后，在service下编写功能接口</p>
<h3 id="AdService接口实现"><a href="#AdService接口实现" class="headerlink" title="AdService接口实现"></a>AdService接口实现</h3><p>​    在上一小节中，把startTime定义成string类型，需要方法将其转换为date类型，定义在工具类utils中，添加到CommonUtils当中；</p>
<p>​    使用apache的DateUtils工具类实现字符串转换，它需要定义一些字符串的格式patterns，只要满足其中一个pattern，就可以实现转换，否则异常，封装这个可能的异常为AdException并抛出。这个方法接收两个参数，一是传入的字符串，二是可以接收的格式</p>
<p>CommonUtils：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.time.DateUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">md5</span><span class="params">(String value)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> DigestUtils.md5Hex(value).toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实现string向date转化的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] parsePatterns =&#123; <span class="comment">//定义下面的转化方法支持的字符串的格式</span></span><br><span class="line">            <span class="string">&quot;yyyy-MM-dd&quot;</span>,<span class="string">&quot;yyyy/MM/dd&quot;</span>,<span class="string">&quot;yyyy.MM.dd&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">parseStringDate</span><span class="params">(String dateString)</span> <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> DateUtils.parseDate(</span><br><span class="line">                    dateString, parsePatterns</span><br><span class="line">            );</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>然后开始编写接口的实现类，放在Impl包下：</p>
<p>创建ad-plan需要去操作AdUserhe和AdPlan，在创建方法中需要注入这两个Dao接口，打上AutoWired注解，根据提示通过构造函数的形式注入；由于操作数据库，方法前加上开启事务注解Transactional，再写方法具体内容</p>
<p>AdPlanServiceImpl:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.service.Impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.constant.CommonStatus;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.AdPlanRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.AdUserRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdPlan;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdUser;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.service.IAdPlanService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.utils.CommonUtils;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdPlanGetRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdPlanRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdPlanResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span> <span class="comment">//标注为bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdPlanServiceImpl</span> <span class="keyword">implements</span> <span class="title">IAdPlanService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdUserRepository userRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdPlanRepository planRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdPlanServiceImpl</span><span class="params">(AdUserRepository userRepository,</span></span></span><br><span class="line"><span class="function"><span class="params">                             AdPlanRepository planRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepository = userRepository;</span><br><span class="line">        <span class="keyword">this</span>.planRepository = planRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdPlanResponse <span class="title">createAdPlan</span><span class="params">(AdPlanRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!request.createValidate())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//确保关联的User是存在的</span></span><br><span class="line">        Optional&lt;AdUser&gt; adUser = userRepository.findById(request.getUserId());</span><br><span class="line">        <span class="keyword">if</span> (!adUser.isPresent())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.CAN_NOT_FIND_RECORD);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//看之前是否定义了同名的AdPlan</span></span><br><span class="line">        AdPlan oldPlan = planRepository.findByUserIdAndPlanName(</span><br><span class="line">                request.getUserId(),request.getPlanName()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (oldPlan != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.SAME_NAME_PLAN_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//jpa的save方法，添加新实例</span></span><br><span class="line">        AdPlan newAdPlan = planRepository.save(</span><br><span class="line">                <span class="keyword">new</span> AdPlan(request.getUserId(),request.getPlanName(),</span><br><span class="line">                        CommonUtils.parseStringDate(request.getStartDate()),</span><br><span class="line">                        CommonUtils.parseStringDate(request.getEndDate()))</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AdPlanResponse(newAdPlan.getId(),newAdPlan.getPlanName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;AdPlan&gt; <span class="title">getAdPlanByIds</span><span class="params">(AdPlanGetRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!request.validate())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> planRepository.findAllByIdInAndUserId(</span><br><span class="line">                request.getIds(),request.getUserId()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdPlanResponse <span class="title">updateAdPlan</span><span class="params">(AdPlanRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!request.updateValidate())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AdPlan plan = planRepository.findByIdAndUserId(</span><br><span class="line">                request.getId(),request.getUserId()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (plan == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.CAN_NOT_FIND_RECORD);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (request.getPlanName() != <span class="keyword">null</span>)&#123;</span><br><span class="line">            plan.setPlanName(request.getPlanName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (request.getStartDate() != <span class="keyword">null</span>)&#123;</span><br><span class="line">            plan.setStartDate(</span><br><span class="line">                    CommonUtils.parseStringDate(request.getStartDate()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (request.getEndDate() != <span class="keyword">null</span>)&#123;</span><br><span class="line">            plan.setEndDate(</span><br><span class="line">                    CommonUtils.parseStringDate(request.getEndDate()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        plan.setUpdateTime(<span class="keyword">new</span> Date());</span><br><span class="line">        plan = planRepository.save(plan);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AdPlanResponse(plan.getId(),plan.getPlanName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAdPlan</span><span class="params">(AdPlanRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!request.deleteValidate())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AdPlan plan = planRepository.findByIdAndUserId(</span><br><span class="line">                request.getId(),request.getUserId()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (plan == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.CAN_NOT_FIND_RECORD);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        plan.setPlanStatus(CommonStatus.INVALID.getStatus());</span><br><span class="line">        plan.setUpdateTime(<span class="keyword">new</span> Date());</span><br><span class="line">        planRepository.save(plan);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>其中增加了两个异常信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.constant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Constants</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorMsg</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REQUEST_PARAM_ERROR = <span class="string">&quot;请求参数错误&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAME_NAME_ERROR = <span class="string">&quot;存在同名的用户&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CAN_NOT_FIND_RECORD =<span class="string">&quot;找不到数据记录&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAME_NAME_PLAN_ERROR = <span class="string">&quot;存在同名的推广计划&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="IUnitService接口和实现"><a href="#IUnitService接口和实现" class="headerlink" title="IUnitService接口和实现"></a>IUnitService接口和实现</h3><p>与前面类似，这里为了简单只定义创建的接口，同同样去定义vo对象</p>
<p>AdUnitRequest：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long planId;</span><br><span class="line">    <span class="keyword">private</span> String unitName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer positionType;</span><br><span class="line">    <span class="keyword">private</span>  Long budget;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">createValidate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span> != planId &amp;&amp; !StringUtils.isEmpty(unitName)</span><br><span class="line">                &amp;&amp; positionType != <span class="keyword">null</span> &amp;&amp; budget !=<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AdUnitResponse：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitResponse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String unitName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IAdUnitService接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdUnitRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdUnitResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IAdUnitService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnitResponse <span class="title">createUnit</span><span class="params">(AdUnitRequest request)</span> <span class="keyword">throws</span> AdException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AdUnitServiceImpl：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.service.Impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.AdPlanRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.AdUnitRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdPlan;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdUnit;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.service.IAdUnitService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdUnitRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdUnitResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitServiceImpl</span> <span class="keyword">implements</span> <span class="title">IAdUnitService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdPlanRepository planRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdUnitRepository unitRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdUnitServiceImpl</span><span class="params">(AdPlanRepository planRepository, AdUnitRepository unitRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.planRepository = planRepository;</span><br><span class="line">        <span class="keyword">this</span>.unitRepository = unitRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdUnitResponse <span class="title">createUnit</span><span class="params">(AdUnitRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!request.createValidate())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Optional&lt;AdPlan&gt; adPlan = planRepository.findById(request.getPlanId());</span><br><span class="line">        <span class="keyword">if</span> (!adPlan.isPresent())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.CAN_NOT_FIND_RECORD);</span><br><span class="line">        &#125;</span><br><span class="line">        AdUnit oldUnit = unitRepository.findByPlanIdAndUnitName(</span><br><span class="line">                request.getPlanId(),request.getUnitName()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (oldUnit != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.SAME_NAME_UNIT_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        AdUnit newUnit = unitRepository.save(</span><br><span class="line">                <span class="keyword">new</span> AdUnit(request.getPlanId(),request.getUnitName(),</span><br><span class="line">                        request.getPositionType(),request.getBudget())</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AdUnitResponse(newUnit.getId(),newUnit.getUnitName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ErrorMsg：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.constant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Constants</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorMsg</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REQUEST_PARAM_ERROR = <span class="string">&quot;请求参数错误&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAME_NAME_ERROR = <span class="string">&quot;存在同名的用户&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CAN_NOT_FIND_RECORD =<span class="string">&quot;找不到数据记录&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAME_NAME_PLAN_ERROR = <span class="string">&quot;存在同名的推广计划&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAME_NAME_UNIT_ERROR = <span class="string">&quot;存在同名的推广单元&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="unit-condition接口和实现"><a href="#unit-condition接口和实现" class="headerlink" title="unit_condition接口和实现"></a>unit_condition接口和实现</h3><p>同样定义vo对象，由于限制条件与ad_unit关联强，接口直接写在IAdUnitService中</p>
<p>共6个vo对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitKeywordRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;UnitKeyword&gt; unitKeywords;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//允许批量创建，定义一个内部类</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UnitKeyword</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long unitId;</span><br><span class="line">        <span class="keyword">private</span> String keyword;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitKeywordResponse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; ids; <span class="comment">//返回主键</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitItRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;UnitIt&gt; unitIts;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UnitIt</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Long unitId;</span><br><span class="line">        <span class="keyword">private</span> String itTag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitItResponse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; ids;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitDistrictRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;UnitDistrict&gt; unitDistricts;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UnitDistrict</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long unitId;</span><br><span class="line">        <span class="keyword">private</span> String province;</span><br><span class="line">        <span class="keyword">private</span> String city;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitDistrictResponse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; ids;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>IAdUnitService接口中添加3个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IAdUnitService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnitResponse <span class="title">createUnit</span><span class="params">(AdUnitRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnitKeywordResponse <span class="title">createUnitKeyword</span><span class="params">(AdUnitKeywordRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnitItResponse <span class="title">createUnitIt</span><span class="params">(AdUnitItRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnitDistrictResponse <span class="title">createUnitDistrict</span><span class="params">(AdUnitDistrictRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AdUnitServiceImpl添加实现这3个方法的具体内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.service.Impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.AdPlanRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.AdUnitRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.unit_condition.AdUnitDistrictRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.unit_condition.AdUnitItRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.unit_condition.AdUnitKeywordRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdPlan;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdUnit;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.unit_condition.AdUnitDistrict;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.unit_condition.AdUnitIt;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.unit_condition.AdUnitKeyword;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.service.IAdUnitService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitServiceImpl</span> <span class="keyword">implements</span> <span class="title">IAdUnitService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdPlanRepository planRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdUnitRepository unitRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdUnitKeywordRepository unitKeywordRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdUnitItRepository unitItRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdUnitDistrictRepository unitDistrictRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdUnitServiceImpl</span><span class="params">(AdPlanRepository planRepository, AdUnitRepository unitRepository,</span></span></span><br><span class="line"><span class="function"><span class="params">                             AdUnitKeywordRepository unitKeywordRepository, AdUnitItRepository unitItRepository,</span></span></span><br><span class="line"><span class="function"><span class="params">                             AdUnitDistrictRepository unitDistrictRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.planRepository = planRepository;</span><br><span class="line">        <span class="keyword">this</span>.unitRepository = unitRepository;</span><br><span class="line">        <span class="keyword">this</span>.unitKeywordRepository = unitKeywordRepository;</span><br><span class="line">        <span class="keyword">this</span>.unitItRepository = unitItRepository;</span><br><span class="line">        <span class="keyword">this</span>.unitDistrictRepository = unitDistrictRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdUnitResponse <span class="title">createUnit</span><span class="params">(AdUnitRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!request.createValidate())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Optional&lt;AdPlan&gt; adPlan = planRepository.findById(request.getPlanId());</span><br><span class="line">        <span class="keyword">if</span> (!adPlan.isPresent())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.CAN_NOT_FIND_RECORD);</span><br><span class="line">        &#125;</span><br><span class="line">        AdUnit oldUnit = unitRepository.findByPlanIdAndUnitName(</span><br><span class="line">                request.getPlanId(),request.getUnitName()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (oldUnit != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.SAME_NAME_UNIT_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        AdUnit newUnit = unitRepository.save(</span><br><span class="line">                <span class="keyword">new</span> AdUnit(request.getPlanId(),request.getUnitName(),</span><br><span class="line">                        request.getPositionType(),request.getBudget())</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AdUnitResponse(newUnit.getId(),newUnit.getUnitName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdUnitKeywordResponse <span class="title">createUnitKeyword</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            AdUnitKeywordRequest request)</span> <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line"></span><br><span class="line">            List&lt;Long&gt; unitIds = request.getUnitKeywords().stream() <span class="comment">//</span></span><br><span class="line">                    .map(AdUnitKeywordRequest.UnitKeyword::getUnitId)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">if</span> (!isRelatedUnitExist(unitIds))&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;Long&gt; ids = Collections.emptyList();</span><br><span class="line">            List&lt;AdUnitKeyword&gt; unitKeywords = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(request.getUnitKeywords()))&#123;</span><br><span class="line"></span><br><span class="line">                request.getUnitKeywords().forEach(i -&gt; unitKeywords.add(</span><br><span class="line">                        <span class="keyword">new</span> AdUnitKeyword(i.getUnitId(),i.getKeyword())</span><br><span class="line">                ));</span><br><span class="line">                ids = unitKeywordRepository.saveAll(unitKeywords).stream()</span><br><span class="line">                        .map(AdUnitKeyword::getId)</span><br><span class="line">                        .collect(Collectors.toList());</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AdUnitKeywordResponse(ids);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdUnitItResponse <span class="title">createUnitIt</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            AdUnitItRequest request)</span> <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//确保关联的推广单元是存在的，否则返回错误</span></span><br><span class="line">        List&lt;Long&gt; unitIds = request.getUnitIts().stream()</span><br><span class="line">                .map(AdUnitItRequest.UnitIt::getUnitId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">if</span> (!isRelatedUnitExist(unitIds))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;AdUnitIt&gt; unitIts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        request.getUnitIts().forEach(i -&gt; unitIts.add(</span><br><span class="line">                <span class="keyword">new</span> AdUnitIt(i.getUnitId(),i.getItTag())</span><br><span class="line">        ));</span><br><span class="line">        List&lt;Long&gt; ids = unitItRepository.saveAll(unitIts).stream()</span><br><span class="line">                .map(AdUnitIt::getId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AdUnitItResponse(ids);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdUnitDistrictResponse <span class="title">createUnitDistrict</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            AdUnitDistrictRequest request)</span> <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//校验传入的unitids是否存在</span></span><br><span class="line">        List&lt;Long&gt; unitIds = request.getUnitDistricts().stream()</span><br><span class="line">                .map(AdUnitDistrictRequest.UnitDistrict::getUnitId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">if</span> (!isRelatedUnitExist(unitIds))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//填充各个ad unit district，新建一个ArrayList，遍历传进来的unit district的list，再添加进去</span></span><br><span class="line">        List&lt;AdUnitDistrict&gt; unitDistricts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        request.getUnitDistricts().forEach(d -&gt; unitDistricts.add(</span><br><span class="line">                <span class="keyword">new</span> AdUnitDistrict(d.getUnitId(),d.getProvince(),d.getCity())</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义保存之后得到的主键</span></span><br><span class="line">        List&lt;Long&gt; ids = unitDistrictRepository.saveAll(unitDistricts).stream()</span><br><span class="line">                .map(AdUnitDistrict::getId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AdUnitDistrictResponse(ids);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//限制单元都需要校验他们的unit ids是否存在，所以定义一个方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRelatedUnitExist</span><span class="params">(List&lt;Long&gt; unitIds)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(unitIds))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//根据unitIds List查对应的所有推广单元的大小，和传入的unitIds的集合大小比较判断（unitIds可能重复）</span></span><br><span class="line">        <span class="keyword">return</span> unitRepository.findAllById(unitIds).size() == <span class="keyword">new</span> HashSet&lt;&gt;(unitIds).size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="ICreativeService接口和实现"><a href="#ICreativeService接口和实现" class="headerlink" title="ICreativeService接口和实现"></a>ICreativeService接口和实现</h3><p>这里也先简单写创建的功能，后续可加增删</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.constant.CommonStatus;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.Creative;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.criteria.CriteriaBuilder;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreativeRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer type;</span><br><span class="line">    <span class="keyword">private</span> Integer materialType;</span><br><span class="line">    <span class="keyword">private</span> Integer height;</span><br><span class="line">    <span class="keyword">private</span> Integer width;</span><br><span class="line">    <span class="keyword">private</span> Long size;</span><br><span class="line">    <span class="keyword">private</span> Integer duration;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义方法使创意转为实体类对象，这样就不用在service层实现它</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Creative <span class="title">convertToEntity</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">            Creative creative = <span class="keyword">new</span> Creative();</span><br><span class="line">            creative.setName(name);</span><br><span class="line">            creative.setType(type);</span><br><span class="line">            creative.setMaterialType(materialType);</span><br><span class="line">            creative.setHeight(height);</span><br><span class="line">            creative.setWidth(width);</span><br><span class="line">            creative.setSize(size);</span><br><span class="line">            creative.setDuration(duration);</span><br><span class="line">            creative.setAuditStatus(CommonStatus.VALID.getStatus());</span><br><span class="line">            creative.setUserId(userId);</span><br><span class="line">            creative.setUrl(url);</span><br><span class="line">            creative.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">            creative.setUpdateTime(creative.getCreateTime());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> creative;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreativeResponse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreateUserRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreativeRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreativeResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICreativeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">CreativeResponse <span class="title">createCreative</span><span class="params">(CreativeRequest request)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.service.Impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.dao.CreativeRepository;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.Creative;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.service.ICreativeService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreateUserRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreativeRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreativeResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreativeServiceImpl</span> <span class="keyword">implements</span> <span class="title">ICreativeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CreativeRepository creativeRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreativeServiceImpl</span><span class="params">(CreativeRepository creativeRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.creativeRepository = creativeRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CreativeResponse <span class="title">createCreative</span><span class="params">(CreativeRequest request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里暂不做校验</span></span><br><span class="line">        Creative creative = creativeRepository.save(</span><br><span class="line">                request.convertToEntity()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreativeResponse(creative.getId(),creative.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="creative-unit接口和实现"><a href="#creative-unit接口和实现" class="headerlink" title="creative_unit接口和实现"></a>creative_unit接口和实现</h3><p>这部分是创建创意与推广单元的关联的接口和实现，其接口方法定义在IAdUnitService中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreativeUnitRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//支持批量创建</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;CreativeUnitItem&gt; unitItems;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CreativeUnitItem</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long creativeId;</span><br><span class="line">        <span class="keyword">private</span> Long unitId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreativeUnitResponse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; ids;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.unit_condition.AdUnitKeyword;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IAdUnitService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnitResponse <span class="title">createUnit</span><span class="params">(AdUnitRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnitKeywordResponse <span class="title">createUnitKeyword</span><span class="params">(AdUnitKeywordRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnitItResponse <span class="title">createUnitIt</span><span class="params">(AdUnitItRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AdUnitDistrictResponse <span class="title">createUnitDistrict</span><span class="params">(AdUnitDistrictRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">CreativeUnitResponse <span class="title">createCreativeUnit</span><span class="params">(CreativeUnitRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>AdUnitServiceImpl：只写了这里添加的方法实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CreativeUnitResponse <span class="title">createCreativeUnit</span><span class="params">(CreativeUnitRequest request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; unitIds = request.getUnitItems().stream()</span><br><span class="line">                .map(CreativeUnitRequest.CreativeUnitItem::getUnitId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; ceativeIds = request.getUnitItems().stream()</span><br><span class="line">                .map(CreativeUnitRequest.CreativeUnitItem::getCreativeId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(isRelatedUnitExist(unitIds) &amp;&amp; isRelatedCreativeExist(ceativeIds)))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AdException(Constants.ErrorMsg.REQUEST_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;CreativeUnit&gt; creativeUnits = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        request.getUnitItems().forEach(i -&gt; creativeUnits.add(</span><br><span class="line">                <span class="keyword">new</span> CreativeUnit(i.getCreativeId(),i.getUnitId())</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; ids = creativeUnitRepository.saveAll(creativeUnits).stream()</span><br><span class="line">                .map(CreativeUnit::getId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CreativeUnitResponse(ids);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//验证创意和推广单元关联时，同样需要验证，还需要一个通过创意id判断对应的创意是否存在的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRelatedCreativeExist</span><span class="params">(List&lt;Long&gt; creativeIds)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(creativeIds))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> creativeRepository.findAllById(creativeIds).size() ==</span><br><span class="line">                <span class="keyword">new</span> HashSet&lt;&gt;(creativeIds).size();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>




<h2 id="Controller服务"><a href="#Controller服务" class="headerlink" title="Controller服务"></a>Controller服务</h2><p>能对外提供http服务，新建controller包</p>
<p>在application.yml配置中，server的context-path: /ad-sponsor。所以所有controller的前缀都是ad-sponsor</p>
<h3 id="UserOPController"><a href="#UserOPController" class="headerlink" title="UserOPController"></a>UserOPController</h3><p>与user有关的服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreateUserRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreateUserResponse;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="meta">@Slf4j</span> <span class="comment">//lombok的日志注解</span></span><br><span class="line"><span class="meta">@RestController</span> <span class="comment">//controller注解，直接返回json类型的数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserOPController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入user service接口，以便调用他的服务</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IUserService userService;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserOPController</span><span class="params">(IUserService userService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IUserService提供了创建用户的接口，所以对外提供的服务也是创建用户</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create/user&quot;)</span> <span class="comment">//post方法,由于application配置，时路径是/ad-sponsor/create/user</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CreateUserResponse <span class="title">createUser</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> CreateUserRequest request)</span> <span class="comment">//这个注解将request反序列化</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">                log.info(<span class="string">&quot;ad-sponsor: createUser -&gt; &#123;&#125;&quot;</span>,</span><br><span class="line">                        JSON.toJSONString(request));<span class="comment">//以json格式打印日志</span></span><br><span class="line">                <span class="keyword">return</span> userService.createUser(request); <span class="comment">//调用createUsr方法</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意请求url是有前缀的，在application配置文件中有定义</p>
<h3 id="AdPlanOPController"><a href="#AdPlanOPController" class="headerlink" title="AdPlanOPController"></a>AdPlanOPController</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.AdPlan;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.service.IAdPlanService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdPlanGetRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdPlanRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.AdPlanResponse;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span>  <span class="title">AdPlanOPController</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IAdPlanService adPlanService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdPlanOPController</span><span class="params">(IAdPlanService adPlanService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.adPlanService = adPlanService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create/adPlan&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdPlanResponse <span class="title">createAdPlan</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> AdPlanRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: createAdPlan -&gt; &#123;]&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        <span class="keyword">return</span> adPlanService.createAdPlan(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/get/adPLan&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;AdPlan&gt; <span class="title">getAdPlanByIds</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> AdPlanGetRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: grtAdPlanByIds -&gt; &#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        <span class="keyword">return</span> adPlanService.getAdPlanByIds(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/update/adPlan&quot;)</span>  <span class="comment">//更新类型的请求，根据restful，用put方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdPlanResponse <span class="title">updateAdPlan</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> AdPlanRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: updateAdPlan -&gt; &#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        <span class="keyword">return</span> adPlanService.updateAdPlan(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/delete/adPlan&quot;)</span>   <span class="comment">//删除</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAdPlan</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> AdPlanRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: deleteAdPlan -&gt; &#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        adPlanService.deleteAdPlan(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>？？？：什么是restful</li>
<li>Slf4j的日志打印</li>
<li>@RequestBody注解和@PostMapping，@PutMapping，@DeleteMapping</li>
</ul>
<h3 id="AdUnitOPController"><a href="#AdUnitOPController" class="headerlink" title="AdUnitOPController"></a>AdUnitOPController</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.entity.unit_condition.AdUnitKeyword;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.service.IAdUnitService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.*;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdUnitOPController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IAdUnitService adUnitService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdUnitOPController</span><span class="params">(IAdUnitService adUnitService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.adUnitService = adUnitService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create/adUnit&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdUnitResponse <span class="title">createUnit</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> AdUnitRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: createUnit -&gt;&#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        <span class="keyword">return</span> adUnitService.createUnit(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create/unitKeyword&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdUnitKeywordResponse <span class="title">createUnitKeyword</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> AdUnitKeywordRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: createUnitKeyword -&gt; &#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        <span class="keyword">return</span> adUnitService.createUnitKeyword(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create/unitIt&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdUnitItResponse <span class="title">createUnitIt</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> AdUnitItRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: createUnitIt -&gt; &#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        <span class="keyword">return</span> adUnitService.createUnitIt(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create/unitDistrict&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdUnitDistrictResponse <span class="title">createUnitDistrict</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> AdUnitDistrictRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: createUnitDistrict -&gt; &#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        <span class="keyword">return</span> adUnitService.createUnitDistrict(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create/creativeUnit&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CreativeUnitResponse <span class="title">createCreativeUnit</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> CreativeUnitRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: createCreativeUnit -&gt; &#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        <span class="keyword">return</span> adUnitService.createCreativeUnit(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="CreativeOPController"><a href="#CreativeOPController" class="headerlink" title="CreativeOPController"></a>CreativeOPController</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.service.ICreativeService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreativeRequest;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CreativeResponse;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarEntry;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreativeOPController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ICreativeService creativeService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreativeOPController</span><span class="params">(ICreativeService creativeService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.creativeService = creativeService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create/creative&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CreativeResponse <span class="title">createCreative</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> CreativeRequest request)</span> <span class="keyword">throws</span> AdException</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ad-sponsor: createCreative -&gt; &#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(request));</span><br><span class="line">        <span class="keyword">return</span> creativeService.createCreative(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="投放系统在网关中的配置"><a href="#投放系统在网关中的配置" class="headerlink" title="投放系统在网关中的配置"></a>投放系统在网关中的配置</h2><p>所有系统的统一入口是网关，所有的请求都会经过网关，网关再会对微服务进行转发。所以这里需要在做一些网关的配置来实现网关的转发</p>
<p>具体参考ad-sponsor和ad-gateway的yml配置文件</p>
<p>ad-sponsor:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7000</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/ad-sponsor</span>   <span class="string">投放系统的统一访问前缀</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-client-ad-sponsor</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">none</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">hibernate.format_sql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">open-in-view:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/imooc_ad_data?autoReconnect=true</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">codingdaidai</span></span><br><span class="line">    <span class="attr">tomcat:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span>   <span class="string">作为一个eureka的client</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://server1:8000/eureka/</span></span><br></pre></td></tr></table></figure>


<p>ad-gateway：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ad-gateway</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://server1:8000/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span>   <span class="string">实现请求转发到对应的服务系统上</span></span><br><span class="line">  <span class="attr">prefix:</span> <span class="string">/imooc</span>  <span class="string">前缀：所有经过网关的请求都有一个前缀即imooc</span></span><br><span class="line">  <span class="attr">routes:</span> <span class="string">路由：针对单个微服务，实现微服务的转发</span></span><br><span class="line">    <span class="attr">sponsor:</span>  <span class="string">微服务名字：这个是投放系统</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/ad-sponsor/**</span>  <span class="string">网关实现转发时，去掉prefix后，再找path前缀对应的微服务。**可匹配任意数量的字符，还可以匹配多级目录</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">eureka-client-ad-sponsor</span> <span class="string">微服务名字，在ad-sponsor配置中有定义</span></span><br><span class="line">      <span class="attr">strip-prefix:</span> <span class="literal">false</span> <span class="string">跳过前缀</span></span><br><span class="line">    <span class="attr">search:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/ad-search/**</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">eureka-client-ad-search</span></span><br><span class="line">      <span class="attr">strip-prefix:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>


<p><strong>strip-prefix的理解：</strong></p>
<p>通过网关访问投放系统的一个微服务：127.0.0.1：9000/imooc/ad-sponsor/create/adPlan</p>
<p>请求先到达网关127.0.0.1：9000，符合网关的前缀/imooc，再往后发现有/ad-sponsor前缀即配置的sponsor微服务的path，也匹配上了，于是会向对应的serviceId转发，此时要看strip-prefix的配置，如果为true，则跳过前缀，即向eureka-client-ad-sponsor转发的是/create/adPlan，会报错（404），因为ad-sponsor中配置了统一访问前缀/ad-sponsor；设为false，不过滤前缀，向serviceId转发的是/ad-sponsor/create/adPlan，可以找到微服务</p>
<h2 id="数据库与数据表的创建"><a href="#数据库与数据表的创建" class="headerlink" title="数据库与数据表的创建"></a>数据库与数据表的创建</h2><p>建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- imooc-ad 数据库</span></span><br><span class="line"><span class="keyword">drop</span> DATABASE imooc_ad_data;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE imooc_ad_data <span class="type">character</span> <span class="keyword">set</span> utf8;</span><br><span class="line"></span><br><span class="line">use imooc_ad_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ad_user` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增主键&#x27;</span>,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `token` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;给用户生成的 token&#x27;</span>,</span><br><span class="line">  `user_status` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;用户状态&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `username` (`username`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;用户信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推广计划表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ad_plan` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增主键&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;标记当前记录所属用户&#x27;</span>,</span><br><span class="line">  `plan_name` <span class="type">varchar</span>(<span class="number">48</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;推广计划名称&#x27;</span>,</span><br><span class="line">  `plan_status` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;推广计划状态&#x27;</span>,</span><br><span class="line">  `start_date` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;推广计划开始时间；&#x27;</span>,</span><br><span class="line">  `end_date` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;推广计划结束时间；&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;推广计划表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推广单元表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ad_unit` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增主键&#x27;</span>,</span><br><span class="line">  `plan_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;关联推广计划 id&#x27;</span>,</span><br><span class="line">  `unit_name` <span class="type">varchar</span>(<span class="number">48</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;推广单元名称&#x27;</span>,</span><br><span class="line">  `unit_status` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;推广单元状态&#x27;</span>,</span><br><span class="line">  `position_type` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;广告位类型(开屏, 贴片, 中贴, 暂停帖, 后贴)&#x27;</span>,</span><br><span class="line">  `budget` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;预算&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;推广单元表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创意表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ad_creative` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增主键&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">48</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创意名称&#x27;</span>,</span><br><span class="line">  `type` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;物料类型(图片, 视频)&#x27;</span>,</span><br><span class="line">  `material_type` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;物料子类型(图片: bmp, jpg 等等)&#x27;</span>,</span><br><span class="line">  `height` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;高度&#x27;</span>,</span><br><span class="line">  `width` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;宽度&#x27;</span>,</span><br><span class="line">  `size` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;物料大小, 单位是 KB&#x27;</span>,</span><br><span class="line">  `duration` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;持续时长, 只有视频才不为 0&#x27;</span>,</span><br><span class="line">  `audit_status` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;审核状态&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;标记当前记录所属用户&#x27;</span>,</span><br><span class="line">  `url` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;物料地址&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01 00:00:00&#x27;</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;创意表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创意与推广单元的关联表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `creative_unit` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `creative_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;创意 id&#x27;</span>,</span><br><span class="line">  `unit_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;推广单元 id&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;创意和推广单元关联表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推广单元关键词 Feature</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ad_unit_keyword` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `unit_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;推广单元 id&#x27;</span>,</span><br><span class="line">  `keyword` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;关键词&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;推广单元关键词 Feature&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推广单元兴趣 Feature</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ad_unit_it` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `unit_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;推广单元 id&#x27;</span>,</span><br><span class="line">  `it_tag` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;兴趣标签&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;推广单元兴趣 Feature&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推广单元地域 Feature</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ad_unit_district` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `unit_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;推广单元 id&#x27;</span>,</span><br><span class="line">  `province` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;省&#x27;</span>,</span><br><span class="line">  `city` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;市&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;推广单元地域 Feature&#x27;</span>;</span><br></pre></td></tr></table></figure>




<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>1.数据库链接error：</p>
<p>在yml配置里datasource url后面加上&amp;&amp;useSSL=false</p>
<p>2.jdbc驱动问题：</p>
<p><code>mysql-connector-java 5.X</code> 之后数据库驱动从com.mysql.jdbc.Driver改为了com.mysql.cj.jdbc.Driver</p>
<p>yml中配置了指定驱动名</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/imooc_ad_data?autoReconnect=true&amp;&amp;useSSL=false</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">codingdaidai</span></span><br><span class="line">  <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>


<p>3.还是数据库链接的问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The server time zone value &#39;ÖÐ¹ú±ê×¼Ê±¼ä&#39; is unrecognized or represents ...</span><br></pre></td></tr></table></figure>
<p>出错的原因是从<code>mysql-connector-java 6</code>开始，连接时需要指定时区<code>serverTimezone</code></p>
<p>再给datasource url指定一下</p>
<p>最后的配置文件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7000</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/ad-sponsor</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-client-ad-sponsor</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">none</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">hibernate.format_sql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">open-in-view:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/imooc_ad_data?autoReconnect=true&amp;&amp;useSSL=false&amp;&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">codingdaidai</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">tomcat:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://server1:8000/eureka/</span></span><br></pre></td></tr></table></figure>


<p>ok终于启动成功了！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/04/25/%E9%A1%B9%E7%9B%AE/3%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%80%9A%E7%94%A8%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/%E9%A1%B9%E7%9B%AE/3%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%80%9A%E7%94%A8%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-25 12:39:01" itemprop="dateCreated datePublished" datetime="2021-04-25T12:39:01+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-15 20:48:10" itemprop="dateModified" datetime="2021-04-15T20:48:10+08:00">2021-04-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="微服务通用模块开发"><a href="#微服务通用模块开发" class="headerlink" title="微服务通用模块开发"></a><strong>微服务通用模块开发</strong></h1><h2 id="通用模块功能"><a href="#通用模块功能" class="headerlink" title="通用模块功能"></a>通用模块功能</h2><h3 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h3><ul>
<li>通用的代码、配置不应该散落在各个业务模块中，不利于维护与更新</li>
<li>一个大的系统，响应对象需要统一外层格式</li>
<li>各种业务设计与实现，可能会抛出各种各样的异常，异常信息的收集也应该做到统一</li>
</ul>
<h3 id="ad-common模块"><a href="#ad-common模块" class="headerlink" title="ad-common模块"></a>ad-common模块</h3><ul>
<li><p>通用代码定义，配置定义：在多个模块中都有的</p>
</li>
<li><p>统一的响应处理：</p>
<p>  ![](D:\Files\Daily Task\images\1617202285(1).png)</p>
</li>
</ul>
<p>​    Http请求的处理过程：当客户端发起http请求，首先到restController或Controller（区别：rest返回一个rest数据，简单认为是一个json类型的数据；Controller视图返回，即前端返回的视图），Controller之后到Service。再到Dao层，最后向http请求返回HttpResponse，例如图中所示的数据（id，name…）</p>
<p>​    存在问题：前后端分离，前端请求，后端返回，后端返回的数据格式千差万别，所以需要一种统一的响应包装。需要将返回的数据包装到json里的data标签里，外层添加了两个标签，code代表响应码，类似于http的响应码，编码代表不同状态，例如0代表正常，其他数字代表不同的异常；message是错误消息</p>
<p>​    实现统一响应用到注解：（Rest)ControllerAdvice 和接口：ResponseBodyAdvice。Advice在spring中代表xxx增强。@（Rest)ControllerAdvice是ControllerAdvice和ResponseBody的语义结合，是控制器增强的意思，会对响应进行拦截吗，然后统一处理响应过程。ResponseBodyAdvice可以控制处理哪些响应以及做什么样的处理。两者结合实现统一响应的功能</p>
<p>​    实行统一响应的好处：统一数据利于前端处理，解析；</p>
<p>​    搜索“http统一响应”</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/126603159">RestFul API 统一响应格式与自动包装</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000019795918">SpringBoot统一响应体解决方案</a></p>
<ul>
<li>统一的异常处理：</li>
</ul>
<p>![](D:\Files\Daily Task\images\1617204205(1).png)</p>
<p>​    问题：在server中可能出现异常，例如图中：AdException是一个自定义的异常。</p>
<pre><code>            1. 直接返回错误对用户不友好
            2. 对异常分类，便于排查问题
            3. 降低业务代码中对异常处理的耦合。如果不统一处理，需要在service（即绿色的）中对每个异常进行try-catch，在catch中对异常包装或处理</code></pre>
<h2 id="统一响应处理的开发"><a href="#统一响应处理的开发" class="headerlink" title="统一响应处理的开发"></a>统一响应处理的开发</h2><h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><p>vo包下是统一响应对象；advice下是控制器拦截</p>
<p>![1618392806(1)](D:\Files\Daily Task\images\1618392806(1).png)</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.vo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span>  <span class="comment">//lombok注解，可以对各个属性实现get和set</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span> <span class="comment">//注解，无参的构造函数</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span> <span class="comment">//全参的构造函数，构造顺序是定义元素的顺序</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResponse</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommonResponse</span><span class="params">(Integer code,String message)</span></span>&#123; <span class="comment">//构造函数</span></span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.advice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestControllerAdvice</span> <span class="comment">//对响应实现统一拦截</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResponseDataAdvice</span> <span class="keyword">implements</span> <span class="title">ResponseBodyAdvice</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//实现两个方法 supports和beforeBodyWrite</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//support方法，响应是否该拦截，是否支持拦截；可以根据方法参数或者类去判断</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter methodParameter,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//在写入响应之前，统一响应CommonResponse应该在这里生成</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object o,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  MethodParameter methodParameter, MediaType mediaType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ServerHttpRequest serverHttpRequest,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ServerHttpResponse serverHttpResponse)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>对有些简单响应例如字符串响应，不用进行统一的拦截，在com.imooc.ad下加一个annotation注解，在其下创建一个IgnoreResponseAdvice注解；这个注解可以使用在类或方法上，将来具体使到Controller上，使其不使用CommonResponse这个响应，具体做法是在supports方法里判断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.advice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.annotation.IgnoreResponseAdvice;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CommonResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestControllerAdvice</span> <span class="comment">//对响应实现统一拦截</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResponseDataAdvice</span> <span class="keyword">implements</span> <span class="title">ResponseBodyAdvice</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//实现两个方法 supports和beforeBodyWrite</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//support方法，响应是否该拦截，是否支持拦截；可以根据方法参数或者类去判断</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span> <span class="comment">//可能产生空指针异常，把这个warning隐藏</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter methodParameter,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//通过methodParameter拿到类的声明，如果这个类的声明被IgnoreResponseAdvice这个注解标识，就返回false，使其不被CommonResponse影响</span></span><br><span class="line">        <span class="keyword">if</span>(methodParameter.getDeclaringClass().isAnnotationPresent(</span><br><span class="line">                IgnoreResponseAdvice.class</span><br><span class="line">        ))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对方法的响应与类同理</span></span><br><span class="line">        <span class="keyword">if</span> (methodParameter.getMethod().isAnnotationPresent(</span><br><span class="line">                IgnoreResponseAdvice.class</span><br><span class="line">        ))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">//除了以上两种情况，均返回true做统一响应，执行beforeBodyWrite方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//在写入响应之前，统一响应CommonResponse应该在这里生成</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object o,//o是一个响应对象</span></span></span><br><span class="line"><span class="function"><span class="params">                                  MethodParameter methodParameter, MediaType mediaType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ServerHttpRequest serverHttpRequest,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ServerHttpResponse serverHttpResponse)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        CommonResponse&lt;Object&gt; response = <span class="keyword">new</span> CommonResponse&lt;&gt;(<span class="number">0</span>,<span class="string">&quot;&quot;</span>);<span class="comment">//定义最终的返回对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span>==o)&#123; <span class="comment">//如果响应对象为空 直接返回，response 不需要设置 data</span></span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (o <span class="keyword">instanceof</span> CommonResponse)&#123; <span class="comment">//如果返回对象o是CommonResponse，不需要再处理</span></span><br><span class="line">            response = (CommonResponse&lt;Object&gt;)o);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123; <span class="comment">//否则, 把响应对象作为 CommonResponse 的 data 部分</span></span><br><span class="line">            response.setData(o);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h3><ol>
<li><p>@RestControllerAdvice 注解：Advice 在 Spring 中的含义就是对 XX 功能增强，RestControllerAdvice（ControllerAdvice）就是对控制器增强。之所以使用 RestControllerAdvice，是因为我们对外提供的都是 Rest 接口（json）。</p>
<p> 我们需要对 Controller 返回的内容做一些额外的工作，即功能增强，就需要利用到这个注解。另外，这个注解提供了 basePackages 属性可以指定对特定 package 中的 Controller 生效。</p>
</li>
<li><p>ResponseBodyAdvice 接口</p>
<p> ResponseBodyAdvice 的作用是在响应体返回之前做一些自定义的处理工作。通常，我们会实现 ResponseBodyAdvice 接口，并包装统一的响应返回。接口的详细定义可以阅读 Spring 官网的解释: <a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/ResponseBodyAdvice.html">Spring ResponseBodyAdvice</a></p>
<ul>
<li><p>supports 方法</p>
<p>  supports 的返回值是 boolean 类型，用于指定哪些 Controller 方法需要处理。我们当前的代码实现是标注了 IgnoreResponseAdvice 注解的类或者方法，统一响应不会生效。</p>
</li>
<li><p>beforeBodyWrite 方法</p>
<p>  根据方法的名字可以知道，这个方法实现了在结果输出前的操作。这个方法的参数很多，我们只需要关注第一个：Object，这个就是原始的 Controller 返回的内容。我们也就是需要对它进行包装。</p>
</li>
</ul>
</li>
<li><p>如果我们对 Controller 返回的结果的处理过程比较复杂，那么根据处理的分类，可以指定多个 ResponseBodyAdvice，并使用 @Order 指定处理顺序。</p>
</li>
</ol>
<h2 id="统一异常处理的开发"><a href="#统一异常处理的开发" class="headerlink" title="统一异常处理的开发"></a>统一异常处理的开发</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>![1618488569(1)](D:\Files\Daily Task\images\1618488569(1).png)</p>
<p>在包exception中定义一个异常；在advice包下创建GlobalExceptionAdvice 类写自己想要的异常处理方法。如果有多个想自己处理的异常，可以继续扩展，优化: 定义多种类异常, 并实现对应的异常处理. 例如: 推广单元的操作出现异常, 抛出 AdUnitException;Binlog 解析异常, 抛出 BinlogException</p>
<h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdException</span> <span class="keyword">extends</span> <span class="title">Exception</span></span>&#123; <span class="comment">//自定义一个统一的异常处理类，可以自己修改</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdException</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);<span class="comment">//定义一个异常，说明要处理的异常类</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.advice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.exception.AdException;</span><br><span class="line"><span class="keyword">import</span> com.imooc.ad.vo.CommonResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestControllerAdvice</span> <span class="comment">//RestControllerAdvice: 组合注解, ControllerAdvice + ResponseBody, 是对 RestController 的功能增强</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionAdvice</span> </span>&#123; <span class="comment">//写自己想要的异常处理方法，对AdException 进行统一处理</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = AdException.class)</span><span class="comment">//ExceptionHandler: 可以对指定的异常进行拦截</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResponse&lt;String&gt; <span class="title">handlerAdException</span><span class="params">(HttpServletRequest req,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                     AdException ex)</span></span>&#123;</span><br><span class="line">         <span class="comment">// 统一异常接口的响应</span></span><br><span class="line">        <span class="comment">// 优化: 定义不同类型的异常枚举(异常码和异常信息)</span></span><br><span class="line">        CommonResponse&lt;String&gt; response = <span class="keyword">new</span> CommonResponse&lt;&gt;(-<span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;business error&quot;</span>);</span><br><span class="line">        response.setData(ex.getMessage());</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h3 id="代码说明-1"><a href="#代码说明-1" class="headerlink" title="代码说明"></a>代码说明</h3><ol>
<li><p>@ExceptionHandler</p>
<p> 拦截 Spring 的异常处理需要使用到 ExceptionHandler 注解。Spring 3.0 引入的这个注解可以让我们在一个 handler 方法或者类中统一处理 Controller 抛出的异常，使得写出的代码更加清晰</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span>             <span class="comment">// 这个注解标注在对象的方法上</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span>     <span class="comment">// 在运行时有效</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ExceptionHandler &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Exceptions handled by the annotated method. If empty, will default to any</span></span><br><span class="line"><span class="comment">	 * exceptions listed in the method argument list.</span></span><br><span class="line"><span class="comment">   * value 是一个 Class 数组，用于指定需要拦截的异常类。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;? extends Throwable&gt;[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​            说明：该注解注释的方法可以有灵活的输入参数，通常需要给出异常参数：包括一般的异常或特定的异常        （即自定义异常），如果注解自身没有指定异常类，会默认进行映射**</p>
<h2 id="统一配置的开发"><a href="#统一配置的开发" class="headerlink" title="统一配置的开发"></a>统一配置的开发</h2><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>定制Http消息转换器，Http消息转换器将Java实体对象转换为http数据输出流，spring boot底层通过HttpMessageConverts这个Jackson库将Java实体类输出为json格式，当有多个转换器可用时，会根据消息类型和需要的数据类型选择合适的转换器使用。要修改这个转换器，最简单的是修改configureMessageConverters这个方法</p>
<h3 id="结构-1"><a href="#结构-1" class="headerlink" title="结构"></a>结构</h3><p>新建conf包存放通用的配置</p>
<h3 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad.conf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">//使其作为配置能被扫描到</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfiguration</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">        converters.clear();</span><br><span class="line">        converters.add(<span class="keyword">new</span> MappingJackson2HttpMessageConverter());<span class="comment">//先清空，只使用一个转换器，MappingJackson2HttpMessageConverter可以将java对象转换为json对象</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="代码说明-2"><a href="#代码说明-2" class="headerlink" title="代码说明"></a>代码说明</h3><ol>
<li><p>WebMvcConfigurer 接口：Spring 的 WebMvcConfigurer 接口提供了很多方法让我们来定制 Spring MVC 的配置。这个接口还是非常常用的，可以对 Spring 的很多配置和行为进行定制。下面对一些常用的方法进行解释：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 匹配路由请求规则</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册自定义的 Formatter 和 Convert</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">addFormatters</span><span class="params">(FormatterRegistry registry)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 添加静态资源处理器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 配置消息转换器</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 添加自定义视图控制器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 添加自定义方法参数处理器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>@Configuration：标注出来后，在广告系统的其他模块引用了ad-common之后，所有请求的响应和请求对象的处理都会通过这个消息转换器做一层过滤处理</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>1：为什么响应对象需要统一格式呢 ？</p>
<pre><code>1. 与前端和客户端保持统一，拥有统一的结构，方便前端和客户端的统一处理，特别是在程序出错的情况下，可以直接显示错误信息。
2. 日志结构的统一，我们经常会把程序的响应以日志的形式打印出来，所以。响应是统一的，日志的结构也能够保持统一。</code></pre>
<p> 2：除了通用的 AdException，你可能还会设计哪些自定义异常类呢？这样设计的理由是什么呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">自定义异常是需要细化到具体的业务的，但是只有当你的某一块业务足够大（或者简单的说就是代码比较多）才需要自定义异常。比如代码中有很多处理推广计划的地方，就可以定义 AdPlanException；代码中处理 MySQL Binlog 的部分很多，就可以定义 MySQLBinlogException 等等。</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/04/25/%E9%A1%B9%E7%9B%AE/2%20%E5%B9%BF%E5%91%8A%E7%B3%BB%E7%BB%9F%E9%AA%A8%E6%9E%B6%E5%BC%80%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/%E9%A1%B9%E7%9B%AE/2%20%E5%B9%BF%E5%91%8A%E7%B3%BB%E7%BB%9F%E9%AA%A8%E6%9E%B6%E5%BC%80%E5%8F%91/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-25 12:39:01" itemprop="dateCreated datePublished" datetime="2021-04-25T12:39:01+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-31 13:47:35" itemprop="dateModified" datetime="2021-03-31T13:47:35+08:00">2021-03-31</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="广告系统骨架开发"><a href="#广告系统骨架开发" class="headerlink" title="广告系统骨架开发"></a>广告系统骨架开发</h1><h2 id="Maven基础"><a href="#Maven基础" class="headerlink" title="Maven基础"></a>Maven基础</h2><h2 id="Maven相关特性"><a href="#Maven相关特性" class="headerlink" title="Maven相关特性"></a>Maven相关特性</h2><h2 id="广告系统主工程"><a href="#广告系统主工程" class="headerlink" title="广告系统主工程"></a>广告系统主工程</h2><p>通过maven创建工程，配置好pom文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>adproject<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>ad-spring-cloud<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Project For Ad SpringCloud<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud.dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestones<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="单节点Eureka-Server"><a href="#单节点Eureka-Server" class="headerlink" title="单节点Eureka Server"></a>单节点Eureka Server</h2><p>Spring Cloud Eureka可以快速实现服务注册与发现，这在微服务项目中非常有意义</p>
<p>springcloud已实现，只用在应用程序上标识是Eureka Server</p>
<p>完成启动程序（.java）和配置文件（.yml）的编写</p>
<p>eureka server启动程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demon.ad;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span><span class="comment">//用两个注解标注他是eurekaserver，启动程序</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>单节点的配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ad-eureka</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost//单机版本</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="string">//是否从eureka</span> <span class="string">server获取注册信息</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="string">//是否将自己注册为eureka</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="string">//设置服务的地址</span></span><br><span class="line">      <span class="string">defaultZone:http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>




<h2 id="Eureka-Server的部署"><a href="#Eureka-Server的部署" class="headerlink" title="Eureka Server的部署"></a>Eureka Server的部署</h2><h3 id="单实例启动"><a href="#单实例启动" class="headerlink" title="单实例启动"></a>单实例启动</h3><p>由于 Eureka Server 已经被 SpringCloud 封装的非常好了，自己需要做的工作很少。所以，如果单实例启动不了，那么，几乎可以肯定是配置文件的问题。另外，需要注意，访问 Eureka 的 url 是：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/%EF%BC%8C%E5%B9%B6%E6%B2%A1%E6%9C%89">http://127.0.0.1:8000/，并没有</a> eureka 后缀。</p>
<h3 id="多节点部署"><a href="#多节点部署" class="headerlink" title="多节点部署"></a>多节点部署</h3><p>为了实现高可用</p>
<p>修改yml文件</p>
<p>创建一个eureka集群</p>
<p> host 文件的功能是实现主机名到 ip 地址的映射。由于我们在开发环境只有一台机器，但是又要搭建 Eureka 集群，所以，通过 ip 注册是做不到的（因为一台机器只有一个 ip 地址）。所以，我们通过主机名实现注册，即在 host 文件中配置了多个主机名（server1、server2、server3），这些主机名当然都是指向当前机器的 ip 地址。所以，根本原因是因为在一台机器上搭建 Eureka 集群的时候，就要把当前的一台机器“变成”多台机器。</p>
<p>修改host</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.2 server1</span><br><span class="line">127.0.0.2 server2</span><br><span class="line">127.0.0.2 server3</span><br></pre></td></tr></table></figure>
<p>cmd进入imooc-ad-spring-cloud下打包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -Dmaven.test.skip&#x3D;true -U</span><br></pre></td></tr></table></figure>
<p>进入到target下启动服务1,2,3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -jar .\ad-eureka-1.0-SNAPSHOT.jar --spring.profiles.active&#x3D;server1</span><br><span class="line">java -jar .\ad-eureka-1.0-SNAPSHOT.jar --spring.profiles.active&#x3D;server2</span><br><span class="line">java -jar .\ad-eureka-1.0-SNAPSHOT.jar --spring.profiles.active&#x3D;server3</span><br></pre></td></tr></table></figure>


<h3 id="eureka介绍"><a href="#eureka介绍" class="headerlink" title="eureka介绍"></a>eureka介绍</h3><p> <strong>核心功能</strong></p>
<ul>
<li>Service Registry（服务注册）</li>
<li>Service Discovery（服务发现）</li>
</ul>
<p><strong>基本架构</strong></p>
<p><strong>Eureka 由三个角色组成：</strong></p>
<ul>
<li>Eureka Server（这一章实现的功能），提供服务注册与发现</li>
<li>Service Provider，服务提供方，将自身服务注册到 Eureka Server 上，从而让 Eureka Server 持有服务的元信息，让其他的服务消费方能够找到当前服务</li>
<li>Service Consumer，服务消费方，从 Eureka Server 上获取注册服务列表，从而能够消费服务</li>
<li>Service Provider/Consumer 相对于 Server，都叫做 Eureka Client</li>
</ul>
<p>![架构](D:\Files\Daily Task\images\eureka-learn0102.png)</p>
<p> <strong>Eureka Server 的高可用</strong></p>
<p>​    <strong>问题说明</strong>：单节点的 Eureka Server 虽然能够实现基础功能，但是存在单点故障的问题，不能实现高可用。因为 Eureka Server 中存储了整个系统中所有的微服务的元数据信息，单节点一旦挂了，所有的服务信息都会丢失，造成整个系统的瘫痪。</p>
<p>​    <strong>解决办法</strong>：搭建 Eureka Server 集群，让各个 Server 节点之间互相注册，从而实现微服务元数据的复制/备份，即使单个节点失效，其他的 Server 节点仍可以继续提供服务</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/138542807">深入了解 Eureka 架构原理及实现</a></p>
<p><a target="_blank" rel="noopener" href="http://mjgao.github.io/2017/10/25/tech-eurekalearn01/">Eureka架构分析</a></p>
<p>问题：eureka server维护了系统中服务的元信息，元信息包含什么，是怎么存储的</p>
<h2 id="微服务架构及网关组件"><a href="#微服务架构及网关组件" class="headerlink" title="微服务架构及网关组件"></a>微服务架构及网关组件</h2><h3 id="微服务架构的两种方式"><a href="#微服务架构的两种方式" class="headerlink" title="微服务架构的两种方式"></a>微服务架构的两种方式</h3><p>1 点对点</p>
<p>![](D:\Files\Daily Task\images\1617113343(1).png)</p>
<p>微服务增多时难以维护</p>
<p>2 API-网关</p>
<p>![](D:\Files\Daily Task\images\1617114641(1).png)</p>
<p>spring cloud通过zuul组件实现gateway</p>
<h3 id="Zuul的生命周期"><a href="#Zuul的生命周期" class="headerlink" title="Zuul的生命周期"></a>Zuul的生命周期</h3><p>![](D:\Files\Daily Task\images\1617115438(1).png)</p>
<ul>
<li>pre filters：身份验证，在集群中选择请求的微服务，记录调试信息</li>
<li>routing filters：构造发送给微服务的请求</li>
<li>post filters：路由到微服务后执行，为响应添加标准的http hider。http头，收集统计信息和指标，将相应从微服务发送给客户端</li>
<li>custom filters：自定义过滤器</li>
<li>error filters：请求发生错误时执行</li>
</ul>
<h2 id="网关启动程序开发"><a href="#网关启动程序开发" class="headerlink" title="网关启动程序开发"></a>网关启动程序开发</h2><p>与eureka启动类似</p>
<p>自定义filter实现访问日志的功能，继承自zuulfilter类，覆盖其中4 个方法</p>
<p>需求：打印访问日志，打印访问请求的延迟，即从请求进入到返回消耗了多少时间</p>
<h3 id="网关启动程序"><a href="#网关启动程序" class="headerlink" title="网关启动程序"></a>网关启动程序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.ad;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.SpringCloudApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.EnableZuulProxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringCloudApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulGatewayApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulGatewayApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>zuul filter编写，通过一个pre filter和一个post filter来打印每次通过网关访问应用程序的时候的日志信息，包含uri和持续时间</p>
<h3 id="pre："><a href="#pre：" class="headerlink" title="pre："></a>pre：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.ZuulFilter;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.context.RequestContext;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.exception.ZuulException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.filters.support.FilterConstants;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span>  <span class="comment">//注解 把filter当作Java bean注册到容器中 lombok</span></span><br><span class="line"><span class="meta">@Component</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreRequestFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;<span class="comment">//改写四个方法</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterConstants.PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line"></span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();<span class="comment">//请求上下文，取当前时间戳</span></span><br><span class="line">        ctx.set(<span class="string">&quot;startTime&quot;</span>,System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ZuulFilter中4个方法的含义：</p>
<ul>
<li>filterType：类型，前面介绍的4种，pre，post，route，error</li>
<li>filterOrder：定义执行顺序，数字越小，顺序越高</li>
<li>shouldFilter：是否执行该filter</li>
<li>run：具体操作</li>
</ul>
<h3 id="post"><a href="#post" class="headerlink" title="post"></a>post</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.ZuulFilter;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.context.RequestContext;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.exception.ZuulException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.filters.support.FilterConstants;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessLogFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterConstants.POST_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterConstants.SEND_RESPONSE_FILTER_ORDER-<span class="number">1</span>;<span class="comment">//需要最后执行。post 过滤器可以有很多个，我们定义的只是其中一个，系统也会有其他的 post 类型过滤器；我这里指定的顺序含义就是在系统的最后一个 post 过滤器执行之前</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line"></span><br><span class="line">        RequestContext context = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = context.getRequest();</span><br><span class="line">        Long startTime = (<span class="keyword">long</span>) context.get(<span class="string">&quot;startTime&quot;</span>); <span class="comment">//取时间</span></span><br><span class="line">        String uri = request.getRequestURI(); <span class="comment">//取uri</span></span><br><span class="line">        <span class="keyword">long</span> duration = System.currentTimeMillis()-startTime;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;uri: &quot;</span>+uri+<span class="string">&quot;, duration: &quot;</span>+duration/<span class="number">100</span>+<span class="string">&quot;ms&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>启动eureka server，看网关能否注册到eureka server上</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/04/25/%E9%A1%B9%E7%9B%AE/1%20%E5%B9%BF%E5%91%8A%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%A7%88%E5%92%8C%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/%E9%A1%B9%E7%9B%AE/1%20%E5%B9%BF%E5%91%8A%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%A7%88%E5%92%8C%E6%9E%B6%E6%9E%84/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-25 12:39:01" itemprop="dateCreated datePublished" datetime="2021-04-25T12:39:01+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-29 19:16:04" itemprop="dateModified" datetime="2021-03-29T19:16:04+08:00">2021-03-29</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="广告系统"><a href="#广告系统" class="headerlink" title="广告系统"></a>广告系统</h1><h2 id="广告系统概览"><a href="#广告系统概览" class="headerlink" title="广告系统概览"></a>广告系统概览</h2><h4 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h4><p>![总体概览](D:\Files\Daily Task\images\1617004338(1).png)</p>
<p>两部分：</p>
<ul>
<li>广告主：投放</li>
<li>媒体方：检索曝光</li>
</ul>
<p>媒体方计费方式：</p>
<ul>
<li>CPM： Cost Per Mille 每千次印象费用</li>
<li>CPT： time 按时间</li>
<li>CPC： click 按点击量</li>
</ul>
<h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><p>![子系统](D:\Files\Daily Task\images\1617004541.png)</p>
<ul>
<li>投放系统：广告主或代理商使用，在系统最前端。既然是广告系统，一定得有广告数据，数据当然是由广告主或代理商投放，那么，也就需要有个投放广告的平台，这就是广告投放系统</li>
<li>检索系统：核心，媒体方才能对接。媒体方对广告系统发起请求，广告系统能够检索符合要求的广告数据，这就是广告检索系统的核心功能</li>
<li>曝光检测系统：本身需要检测，另一方面广告主可能请第三方检测</li>
<li>扣费系统：广告主投放初需要预算，预算花完系统不再展现，且这个系统里面负责了将广告数据置位的功能</li>
<li>报表系统：两部分：内部看数据；构建广告数据报表，比如广告A在地域B中一共曝光了多少次，主要是 OLAP 的过程</li>
</ul>
<h3 id="3"><a href="#3" class="headerlink" title="3"></a>3</h3><p>使用的技术：springcloud，mysql，kafka</p>
<h3 id="4"><a href="#4" class="headerlink" title="4"></a>4</h3><p>如何扩展：更多维度；用户画像；AI…</p>
<h2 id="广告系统架构"><a href="#广告系统架构" class="headerlink" title="广告系统架构"></a>广告系统架构</h2><p>![](D:\Files\Daily Task\images\1617015939.png)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/04/25/Linux%2003/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/Linux%2003/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-25 12:38:44" itemprop="dateCreated datePublished" datetime="2021-04-25T12:38:44+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-26 12:31:00" itemprop="dateModified" datetime="2021-03-26T12:31:00+08:00">2021-03-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="时间日期类指令"><a href="#时间日期类指令" class="headerlink" title="时间日期类指令"></a>时间日期类指令</h2><ol>
<li>date：显示当前日期<ul>
<li>date</li>
<li>date “+%Y”</li>
<li>date “+%m”</li>
<li>date “+%d”</li>
<li>date”+%Y-%m-%d %H:%M:%S“</li>
</ul>
</li>
<li>date 设置日期<ul>
<li>date -s 字符串时间</li>
</ul>
</li>
<li>cal:查看日历<ul>
<li>cal [选项]  如cal 2020显示一年的日历</li>
</ul>
</li>
</ol>
<h2 id="搜索查找类"><a href="#搜索查找类" class="headerlink" title="搜索查找类"></a>搜索查找类</h2><ol>
<li>find：从指定目录向下递归遍历其各个子目录，将满足条件的文件或目录显示在终端<ul>
<li>find [搜索范围] [选项] </li>
<li>选项：-name&lt;查询方式&gt; 按指定的文件名查找模式查找文件 -user&lt;&gt;  查找属于指定应户名的所有文件 -size&lt;&gt; 按照指定的文件大小查找文件</li>
<li>eg：find /home -user demon</li>
<li>eg：find aaa -name hi.txt</li>
<li>eg：find / -size +20M 查找大于20M的文件</li>
</ul>
</li>
<li>locate：快速定位文件路径，查询速度较快，无需遍历整个文件系统，利用实现建立的locate数据库快速定位<ul>
<li>locate 搜索文件</li>
<li>说明：第一次运行前，必须用updatedb指令创建locate数据库</li>
</ul>
</li>
<li>grep指令和管道符号|:grep过滤查找，|表示将前一个命令的处理结果输出传递给后面的命令处理<ul>
<li>grep [选项] 查找内容 源文件</li>
<li>选项：-n 显示匹配行及行号   -i  忽略字母大小写</li>
<li>eg：cat hi.txt|grep -n demon</li>
</ul>
</li>
</ol>
<h2 id="压缩和解压类"><a href="#压缩和解压类" class="headerlink" title="压缩和解压类"></a>压缩和解压类</h2><ol>
<li>gzip和gunzip（gz）<ul>
<li>gzip 文件</li>
<li>gunzip 文件.gz</li>
</ul>
</li>
<li>zip和unzip<ul>
<li>zip [选项] xxx.zip</li>
<li>unzip [选项] xxx.zip</li>
<li>选项：<ul>
<li>zip常用：-r 递归压缩，即压缩目录</li>
<li>unzip常用：-d &lt;目录&gt;  压缩文件 ：指定解压后文件的存放目录 </li>
</ul>
</li>
<li>eg：zip -r package.zip /home/demon/aaa    把路径表示的整个文件夹打包压缩到当前所处位置</li>
</ul>
</li>
<li>tar：打包，最后打包的文件是,tar.gz文件<ul>
<li>tar [选项] xxx.tar.gz 打包内容  ：打包目录</li>
<li>选项：<ul>
<li>-c 产生.tar打包文件</li>
<li>-v 显示详细信息</li>
<li>-f 指定压缩后的文件名</li>
<li>-z 打包同时压缩</li>
<li>-x 解包.tar文件</li>
</ul>
</li>
<li>eg：tar -zcvf a.tar.gz hi.txt 222.txt ：把后面两个文件打包压缩为指定文件名并显示详细信息</li>
<li>eg：tar -zxvf b.tar.gz：解压到当前文件夹</li>
<li>eg：ar -zxvf a.tar.gz -C /home/demon ：解压到一个已存在的目录（-C选项。change to dir）</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/03/08/Linux%2002/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/08/Linux%2002/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-03-08 22:07:06 / Modified: 22:05:35" itemprop="dateCreated datePublished" datetime="2021-03-08T22:07:06+08:00">2021-03-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="实用指令"><a href="#实用指令" class="headerlink" title="实用指令"></a>实用指令</h1><h2 id="指令运行级别"><a href="#指令运行级别" class="headerlink" title="指令运行级别"></a>指令运行级别</h2><ul>
<li>0：关机</li>
<li>1：单用户（找回丢失密码）</li>
<li>2：多用户无网络服务</li>
<li>3：多用户有网络服务</li>
<li>4：保留</li>
<li>5：图形界面</li>
<li>6：重启</li>
</ul>
<p>常用的运行级别是3，5，要修改默认的运行级别可修改配置文件</p>
<p>系统的运行级别配置文件：/etc/inittab (注意：centos7不支持），可修改开机运行的默认级别。centos7可以直接用set-default :将默认运行级别设置为指定的target；</p>
<p>centos7不再使用/etc/inittab文件进行默认的启动级别配置，而使用比sysvinit的运行级更为自由的target替代。第3运行级用multi-user.target替代，第5运行级用graphical.target替代。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/renshengdezheli/p/13935307.html">centos7运行级别</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lhdz_bj/p/10084310.html">centos7运行级别设置</a></p>
<ul>
<li><p>运行级别对应关系</p>
<pre><code>init level       systemctl target
0            shutdown.target
1            emergency.target
2            rescure.target
3            multi-user.target
4            无
5            graphical.target
6            reboot.target</code></pre>
</li>
<li><p>运行级别设置</p>
<ul>
<li><p>语法：systemctl [command] [unit.target]</p>
</li>
<li><p>命令及参数</p>
<ul>
<li><p>command部分</p>
<p>get-default :获取当前的target；</p>
<p>set-default :将默认运行级别设置为指定的target；</p>
<p>isolate :切换至指定的运行级别。</p>
</li>
<li><p>unit.target部分：为上面1节部分中给出的运行级别</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>常用运行级别相关命令</p>
<ul>
<li>systemctl<ul>
<li>systemctl get-default：获取当前的运行级别；</li>
<li>systemctl set-default multi-user.target：将默认运行级别设置为mulit-user；</li>
<li>systemctl isolate multi-user.target：不重启系统的情况下，将运行级别切换至mulit-user；</li>
<li>systemctl isolate graphical.target：不重启系统的情况下，将运行级别切换至图形模式</li>
</ul>
</li>
<li>其他：<ul>
<li>runlvel：返回结果中，第一个数为之前运行级别，后一个数为当前运行级别；</li>
<li>init 5：将当前运行级别切换至5（图形模式）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="切换到指令运行级别的指令"><a href="#切换到指令运行级别的指令" class="headerlink" title="切换到指令运行级别的指令"></a>切换到指令运行级别的指令</h2><p>init[0123456]</p>
<p><strong>找回root密码：</strong></p>
<p>思路：进入到单用户模式，然后修改root密码，因为单用户模式root不需要密码就可以登录</p>
<p>方法：启动时按enter，在kernel下按e，在该行最后 输入1再enter，再输入b开始引导，此时以root身份登入单用户模式，然后再用passwd修改密码</p>
<h2 id="帮助指令"><a href="#帮助指令" class="headerlink" title="帮助指令"></a>帮助指令</h2><p>了解指令的使用方法</p>
<ul>
<li><p>基本语法：man 命令或配置文件 （用法）</p>
<p>  ​                    help 命令  （功能描述）</p>
</li>
</ul>
<h2 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h2><ol>
<li>pwd： 显示当前工作目录的绝对路径</li>
<li>ls：ls 选项 目录或文件<ul>
<li>ls -a 显示当前目录的所有文件和目录，包括隐藏的（隐藏文件以 . 开头）</li>
<li>ls -l 以列表的方式显示信息</li>
</ul>
</li>
<li>cd：切换目录<ul>
<li>语法：cd 参数 </li>
<li>cd 绝对路径或相对路径</li>
<li>cd ：或者cd~ :切换到自己的家目录</li>
<li>cd.. ：回到当前目录的上一级目录</li>
</ul>
</li>
<li>mkdir：创建目录<ul>
<li>mkdir -p ：创建多级目录</li>
</ul>
</li>
<li>rmdir：删除空目录</li>
<li>rm -rf：删除非空目录</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://codingdaidai.github.io/2021/03/07/Linux%2001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lingyun Zhou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codingdaidai">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/07/Linux%2001/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-03-07 21:08:01 / Modified: 21:06:38" itemprop="dateCreated datePublished" datetime="2021-03-07T21:08:01+08:00">2021-03-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h1><h2 id="共享文件夹设置"><a href="#共享文件夹设置" class="headerlink" title="共享文件夹设置"></a>共享文件夹设置</h2><p>环境：VMware 15.5 + CentOS 7</p>
<p>问题：常规设置共享文件夹后Linux内没有</p>
<p>解决：重新安装VM Tools</p>
<p>参考:<a target="_blank" rel="noopener" href="https://blog.csdn.net/yhahaha_/article/details/82625067">（CentOS 7）重新安装VMware Tools，建立共享文件夹，及安装文件没有出现问题的解决</a></p>
<p>关键：重装之前安装两个依赖 su root进到root用户下</p>
<ol>
<li>安装gcc：yum -y install gcc</li>
<li>安装kernel-devel：yum -y install kernel-devel</li>
</ol>
<p>reboot后再进行VM Tools安装，解压后执行pl文件即可</p>
<p>共享文件夹位置固定在 /mnt/hgfs 这个位置</p>
<h1 id="Linux目录结构"><a href="#Linux目录结构" class="headerlink" title="Linux目录结构"></a>Linux目录结构</h1><p>基本结构：级层式的树状目录结构，此结构的最上层是根目录“/”，然后在此基础上再创建其他的目录。各个目录存放的文件是规划好的</p>
<p>根目录下各目录存放的内容：</p>
<p>（一切皆文件）</p>
<h1 id="远程登录X-Shell"><a href="#远程登录X-Shell" class="headerlink" title="远程登录X-Shell"></a>远程登录X-Shell</h1><p>软件：XShell6 远程登录到Linux</p>
<p>​            XFtp6 远程上传下载文件</p>
<p>注意：需要Linux开启sshd服务 该服务会监听22号端口，使xshell可远程访问</p>
<p>​            终端 setup回车，sshd服务</p>
<p>过程：XShell中新建会话，使用Linux中的ip地址（ifconfig）和用户名密码，登录成功后即可控制该Linux</p>
<h1 id="远程上传下载文件XFtp6"><a href="#远程上传下载文件XFtp6" class="headerlink" title="远程上传下载文件XFtp6"></a>远程上传下载文件XFtp6</h1><p>与xshell类似</p>
<h1 id="VI和VIM编辑器"><a href="#VI和VIM编辑器" class="headerlink" title="VI和VIM编辑器"></a>VI和VIM编辑器</h1><p><strong>三种常见模式</strong>：</p>
<ul>
<li>正常模式：默认模式</li>
<li>插入模式：按下i或o，a，r等任意字母后进入</li>
<li>命令行模式：完成读取，存盘，替换，离开vim，显示行号等操作，输入esc，再输入冒号：或者斜杠/，即可输入命令行，wq写入并退出，q！退出且不保存，q不做修改的退出</li>
</ul>
<p><strong>快捷键使用案例</strong></p>
<ul>
<li> 拷贝当前行 yy，拷贝当前向下的5行  5yy，并粘贴（p）</li>
<li>删除当前行dd，删除当前行向下的5行，5dd</li>
<li>在文件中查找某个单词 命令行下 /关键字   ，回车 查找，输入n就是查找的下一个</li>
<li>设置文件的行号，取消文件的行号，命令行下  ：set nu 和:set nonu</li>
<li>编辑 /etc/profile文件，使用快捷键到底文档的最末行（G）和最首行（gg），在正常模式下</li>
<li>在一个文件中输入“hello”，然后又撤销这个动作 ，正常模式下输入u</li>
<li>编辑 /etc/profile文件，并将光标移动到第20行  首先显示行号 ：set nu  然后输入行号20  再输入shift+g</li>
</ul>
<h1 id="关机-重启-用户登录和注销"><a href="#关机-重启-用户登录和注销" class="headerlink" title="关机 重启 用户登录和注销"></a>关机 重启 用户登录和注销</h1><p><strong>命令</strong></p>
<ul>
<li>关机&amp;重启：<ul>
<li>shutdown -h now 立即关机</li>
<li>shutdown -h 1 1分钟后关机</li>
<li>shutdown -r  now  立即重启</li>
<li>halt 关机</li>
<li>reboot 重启</li>
<li>sync 把内存的数据同步到磁盘（关机或重启之前执行）</li>
</ul>
</li>
<li>用户登录和注销<ul>
<li>登录时尽量少使用root账号，因为其权限较高，避免操作失误，可用普通用户登录，再用su -用户名来切换成管理员身份；提示符下输入logout即可注销账户（注销远程连接，在运行级别3下有效）</li>
</ul>
</li>
</ul>
<h1 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h1><p><strong>框架</strong> </p>
<p>不同的用户 → 用户组 → 用户家目录</p>
<p>家目录的概念：/home/目录下有各个创建的用户对应的家目录，当用户登录时，会自动的进入到自己的家目录</p>
<p>Linux用户需要至少属于一个组</p>
<p><strong>添加用户</strong></p>
<p>useradd [选项] 用户名 ：会自动创建和用户同名的家目录</p>
<p>useradd -d 指定目录 新的用户名：给新创建的用户指定家目录</p>
<p><strong>指定密码</strong></p>
<p>passwd 用户名  （在root权限下）</p>
<p><strong>删除用户</strong></p>
<p>userdel 用户名：会保留家目录（开发中可保留）</p>
<p>userdel -r 用户名：不保留家目录</p>
<p><strong>查询用户信息</strong></p>
<p>id 用户名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 demon]# id root</span><br><span class="line">uid&#x3D;0(root) gid&#x3D;0(root) 组&#x3D;0(root)</span><br></pre></td></tr></table></figure>
<p>user id；group id ；组</p>
<p><strong>切换用户</strong></p>
<p>当前权限不够，通过 su指令切换到高权限用户，比如root</p>
<p>su 切换用户名：切换用户</p>
<p>exit ：返回到原先用户</p>
<p><strong>查看当前用户</strong></p>
<p>whoami</p>
<p><strong>用户组</strong></p>
<p>系统可以对有共性的多个用户进行统一的管理</p>
<ul>
<li><p>新增组：</p>
<p>  groupadd 组名</p>
</li>
<li><p>删除组：</p>
<p>  groupdel 组名</p>
</li>
<li><p>增加用户时直接指定组名：</p>
<p>  useradd -g 用户组 用户名</p>
</li>
<li><p>修改用户的组</p>
<p>  usermod  -g 用户组 用户名</p>
</li>
</ul>
<p><strong>用户和组的配置文件</strong></p>
<ul>
<li><p>用户配置文件（用户信息）：/etc/passwd（用vim编辑查看）</p>
<p>  每行的含义：用户名:口令：用户标识号：组标识号：注释性描述：主目录：登录shell</p>
</li>
<li><p>组配置文件（组信息）：/etc/group</p>
<p>  每行的含义：组名：口令：组标识号：组内用户列表</p>
</li>
<li><p>口令配置文件（密码和登录信息，是加密）：/etc/shadow</p>
<p>  每行的含义：登录名:加密口令：最后一次修改时间表：最小时间间隔：最大时间间隔：失效时间：标志</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Lingyun Zhou</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lingyun Zhou</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
